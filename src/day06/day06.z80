
; program day06.pas

CPM:            equ     1               ; Target is CP/M .com file
                device  NOSLOT64K
; [0] (* ===================================================================== *)
; [1] (* === CP/M run-time library =========================================== *)
; [2] (* ===================================================================== *)
; [3] 
; [4] {$a org 0x0100  }
                org     0x0100
; [5] {$a             }

; [6] {$a jp __init   }
                jp      __init
; [7] 
; [8] {$i system.pas  }
; [0] (* Built-ins that do not have to be defined in the compiler itself. *)
; [1] 
; [2] {$a+}
; [3] 
; [4] {$l system.asm}
                include "/Users/joerg/Projects/pasta80/rtl/system.asm"
; [5] 
; [6] (* -------------------------------------------------------------------------- *)
; [7] (* --- String support ------------------------------------------------------- *)
; [8] (* -------------------------------------------------------------------------- *)
; [9] 
; [10] (* Built-in: procedure Val(S: String; var Scalar; var E: Integer); *)
; [11] (* Built-in: procedure Str(N: Scalar; var S: String);              *)
; [12] 
; [13] procedure Delete(var S: String; Start, Count: Integer);     external '__delete';
; [14] procedure Insert(S: String; var T: String; Start: Integer); external '__insert';

; [15] 
; [16] (* Built-in: function Concat(S: String, ...): String;              *)
; [17] 
; [18] function Copy(S: String; Start, Count: Integer): String;    external '__copy';

; [19] function Length(S: String): Integer;                        external '__length';

; [20] function Pos(S, T: String): Integer;                        external '__pos';

; [21] 
; [22] (* -------------------------------------------------------------------------- *)
; [23] (* --- Set support ---------------------------------------------------------- *)
; [24] (* -------------------------------------------------------------------------- *)
; [25] 
; [26] (* Built-in: procedure Include(var S: Set; E: Element);     *)
; [27] (* Built-in: procedure Exclude(var S: Set; E: Element);     *)
; [28] 
; [29] (* -------------------------------------------------------------------------- *)
; [30] (* --- File support --------------------------------------------------------- *)
; [31] (* -------------------------------------------------------------------------- *)
; [32] 
; [33] (* TBD *)
; [34] 
; [35] (* -------------------------------------------------------------------------- *)
; [36] (* --- Heap management ------------------------------------------------------ *)
; [37] (* -------------------------------------------------------------------------- *)
; [38] 
; [39] type

; [40]   PBlock = ^TBlock;
; [41]   TBlock = record
; [42]     Next: PBlock;
; [43]     Size: Integer;
; [44]   end;
; [45] 
; [46] var
; [47]   HeapPtr: PBlock absolute '__heapptr';
; [48] 
; [49] (* Built-in: procedure New(var P: Pointer);       *)
; [50] (* Built-in: procedure Dispose(P: Pointer);       *)
; [51] 
; [52] procedure FreeMem(P: Pointer; Size: Integer);     register; external '__freemem';
; [53] procedure GetMem(var P: Pointer; Size: Integer);  register; external '__getmem';

; [54] 
; [55] function MemAvail: Integer;

; [56] var
; [57]   P: PBlock;
global8:        ds      2,0             ; Global P
; [58]   I: Integer;
global9:        ds      2,0             ; Global I
; [59] begin
; var MemAvail(@RESULT), P(@global8), I(@global9)

__MemAvail7:                            ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
                push    hl
; [60]   P := HeapPtr;
                ld      hl,global8 + 0
                push    hl
                ld      hl,__heapptr + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [61]   I := 0;
                ld      hl,global9 + 0
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [62]   while P <> nil do
while11:
                ld      hl,global8 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
; [63]   begin
                pop     hl
                bit     0,l
                jp      z,false12
; [64]     I := I + P^.Size;
                ld      hl,global9 + 0
                push    hl
                ld      hl,global9 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      hl,global8 + 0
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,2            ; Literal 2
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     de
                pop     hl
                ld      (hl),de
; [65]     P := P^.Next;
                ld      hl,global8 + 0
                push    hl
                ld      hl,global8 + 0
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [66]   end;
                jp      while11
false12:
; [67] 
; [68]   MemAvail := I;
                ld      hl,(display+2)  ; Local MemAvail
                ld      de,4
                add     hl,de
                push    hl
                ld      hl,global9 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [69] end;
exit10:         ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [70] 
; [71] function MaxAvail: Integer;

; [72] var
; [73]   P: PBlock;
global14:       ds      2,0             ; Global P
; [74]   I: Integer;
global15:       ds      2,0             ; Global I
; [75] begin
; var MaxAvail(@RESULT), P(@global14), I(@global15)

__MaxAvail13:                           ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
                push    hl
; [76]   P := HeapPtr;
                ld      hl,global14 + 0
                push    hl
                ld      hl,__heapptr + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [77]   I := 0;
                ld      hl,global15 + 0
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [78]   while P <> nil do
while17:
                ld      hl,global14 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
; [79]   begin
                pop     hl
                bit     0,l
                jp      z,false18
; [80]     if P^.Size > I then I := P^.Size;
                ld      hl,global14 + 0
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,2            ; Literal 2
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      hl,global15 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     hl              ; RelOp 13
                pop     de
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false19
                ld      hl,global15 + 0
                push    hl
                ld      hl,global14 + 0
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,2            ; Literal 2
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
false19:
; [81]     P := P^.Next;
                ld      hl,global14 + 0
                push    hl
                ld      hl,global14 + 0
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [82]   end;
                jp      while17
false18:
; [83] 
; [84]   MaxAvail := I;
                ld      hl,(display+2)  ; Local MaxAvail
                ld      de,4
                add     hl,de
                push    hl
                ld      hl,global15 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [85] end;
exit16:         ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [86] 
; [87] procedure InitHeap;

; [88] var
; [89]   EofMarker: Integer absolute 'eof';
; [90]   HeapStart, HeapBytes: Integer;
global21:       ds      2,0             ; Global HeapStart
global22:       ds      2,0             ; Global HeapBytes
; [91] begin
; var EofMarker(@eof), HeapStart(@global21), HeapBytes(@global22)

__InitHeap20:                           ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
                push    hl
                push    hl
; [92]   HeapStart := Addr(EofMarker);
                ld      hl,global21 + 0
                push    hl
                ld      hl,eof + 0
                push    hl
                pop     de
                pop     hl
                ld      (hl),de
; [93]   if (HeapStart >= 0) and (HeapStart < 24576) then HeapStart := 24576;
                ld      hl,global21 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 14
                pop     hl
                call    __int16_geq
                ld      h,0
                ld      l,a
                push    hl
                ld      hl,global21 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,24576        ; Literal 24576
                push    de
                pop     de              ; RelOp 11
                pop     hl
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
                pop     de
                pop     hl
                ld      a,l
                and     e
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false24
                ld      hl,global21 + 0
                push    hl
                ld      de,24576        ; Literal 24576
                push    de
                pop     de
                pop     hl
                ld      (hl),de
false24:
; [94]   HeapBytes := 57343 - HeapStart;
                ld      hl,global22 + 0
                push    hl
                ld      de,57343        ; Literal 57343
                push    de
                ld      hl,global21 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                xor     a
                sbc     hl,de
                push    hl
                pop     de
                pop     hl
                ld      (hl),de
; [95]   HeapPtr := nil;
                ld      hl,__heapptr + 0
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [96] 
; [97]   if HeapBytes > 0 then
                ld      hl,global22 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     hl              ; RelOp 13
                pop     de
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
; [98]     FreeMem(Ptr(HeapStart), HeapBytes);
                pop     hl
                bit     0,l
                jp      z,false25
                ld      hl,global21 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      hl,global22 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                call    __freemem
false25:
; [99] end;
exit23:         ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [100] 
; [101] (* -------------------------------------------------------------------------- *)
; [102] (* --- Standard procedures -------------------------------------------------- *)
; [103] (* -------------------------------------------------------------------------- *)
; [104] 
; [105] (* Built-in: procedure Break;                   *)
; [106] (* Built-in: procedure Continue;                *)
; [107] (* Built-in: procedure Exit;                    *)
; [108] 
; [109] const

; [110]   Black   = 0;
; [111]   Blue    = 1;
; [112]   Red     = 2;
; [113]   Magenta = 3;
; [114]   Green   = 4;
; [115]   Cyan    = 5;
; [116]   Yellow  = 6;
; [117]   White   = 7;
; [118] 
; [119] 
; [120] 
; [121] (* -------------------------------------------------------------------------- *)
; [122] (* --- Arithmetic functions ------------------------------------------------- *)
; [123] (* -------------------------------------------------------------------------- *)
; [124] 
; [125] const
; [126]   MaxInt = 32767;
; [127]   MinInt = -32768;
; [128] 
; [129] (* Built-in: function Abs(I: Integer): Integer  *)
; [130] (* Built-in: function Abs(R: Real): Real        *)
; [131] 
; [132] function ArcTan(R: Real): Real; register; external 'ATN';
; [133] function Cos(R: Real): Real; register;    external 'COS';

; [134] function Exp(R: Real): Real; register;    external 'EXP';

; [135] function Frac(R: Real): Real; register;   external 'FRAC';

; [136] function Int(R: Real): Real; register;    external 'INT';

; [137] function Ln(R: Real): Real; register;     external 'LN';

; [138] function Log(R: Real): Real; register;    external 'LOG';

; [139] function Sin(R: Real): Real; register;    external 'SIN';

; [140] function Sqr(R: Real): Real; register;    external '__fltpwr2';

; [141] function Sqrt(R: Real): Real; register;   external 'SQR';

; [142] function Tan(R: Real): Real; register;    external 'TAN';

; [143] 
; [144] function Pi: Real; register;              external 'ACPI';

; [145] 
; [146] function MaxReal: Real; register; inline

__MaxReal38:
; [147] (
; [148]   $01 / $7FFF /
                db      1
                dw      32767
; [149]   $11 / $FFFF /
                db      17
                dw      65535
; [150]   $21 / $FFFF /
                db      33
                dw      65535
; [151]   $c9
; [152] );
                db      201
                ret
; [153] 
; [154] function MinReal: Real; register; inline

__MinReal39:
; [155] (
; [156]   $01 / $FFFF /
                db      1
                dw      65535
; [157]   $11 / $FFFF /
                db      17
                dw      65535
; [158]   $21 / $FFFF /
                db      33
                dw      65535
; [159]   $c9
; [160] );
                db      201
                ret
; [161] 
; [162] (* -------------------------------------------------------------------------- *)
; [163] (* --- Scalar functions ----------------------------------------------------- *)
; [164] (* -------------------------------------------------------------------------- *)
; [165] 
; [166] (* Built-in: function Pred(Ordinal): Ordinal;     *)
; [167] (* Built-in: function Succ(Ordinal): Ordinal;     *)
; [168] (* Built-in: function Odd(Ordinal): Boolean;      *)
; [169] (* Built-in: function Even(Ordinal): Boolean;     *)
; [170] 
; [171] (* -------------------------------------------------------------------------- *)
; [172] (* --- Transfer functions --------------------------------------------------- *)
; [173] (* -------------------------------------------------------------------------- *)
; [174] 
; [175] (* Built-in: function Ord(Ordinal): Integer;      *)
; [176] 
; [177] function Round(R: Real): Integer; register; external '__fltrnd';

; [178] function Trunc(R: Real): Integer; register; external 'FIX';

; [179] 
; [180] function Chr(B: Byte): Char; register; inline

__Chr42:
; [181] (
; [182]   $c9         (* ret          *)
; [183] );
                db      201
                ret
; [184] 
; [185] (* -------------------------------------------------------------------------- *)
; [186] (* --- Miscellaneous standard functions ------------------------------------- *)
; [187] (* -------------------------------------------------------------------------- *)
; [188] 
; [189] (* Built-in: function KeyPressed: Boolean;        *)
; [190] (* Built-in: function SizeOf(XYZ): Integer;       *)
; [191] (* Built-in: function Addr(XYZ): Integer;         *)
; [192] (* Built-in: function Ptr(I: Integer): Pointer;   *)
; [193] 
; [194] function Hi(I: Integer): Byte; register; inline

__Hi43:
; [195] (
; [196]   $6c /       (* ld   l,h     *)
                db      108
; [197]   $26 / $00 / (* ld   h,0     *)
                db      38
                db      0
; [198]   $c9         (* ret          *)
; [199] );
                db      201
                ret
; [200] 
; [201] function Lo(I: Integer): Byte; register; inline

__Lo44:
; [202] (
; [203]   $26 / $00 / (* ld   h,0     *)
                db      38
                db      0
; [204]   $c9         (* ret          *)
; [205] );
                db      201
                ret
; [206] 
; [207] function Swap(I: Integer): Integer; register; inline

__Swap45:
; [208] (
; [209]   $7c /       (* ld   a,h     *)
                db      124
; [210]   $65 /       (* ld   h,l     *)
                db      101
; [211]   $6f /       (* ld   l,a     *)
                db      111
; [212]   $c9         (* ret          *)
; [213] );
                db      201
                ret
; [214] 
; [215] function UpCase(C: Char): Char; register; inline

__UpCase46:
; [216] (
; [217]   $7d /       (* ld   a,l     *)
                db      125
; [218]   $fe / $61 / (* cp   'a'     *)
                db      254
                db      97
; [219]   $d8 /       (* ret  c       *)
                db      216
; [220]   $fe / $7b / (* cp   'z' + 1 *)
                db      254
                db      123
; [221]   $d0 /       (* ret  nc      *)
                db      208
; [222]   $cb / $ad / (* res  4,l     *)
                db      203
                db      173
; [223]   $c9         (* ret          *)
; [224] );
                db      201
                ret
; [225] 
; [226] function LoCase(C: Char): Char; register; inline

__LoCase47:
; [227] (
; [228]   $7d /       (* ld   a,l     *)
                db      125
; [229]   $fe / $41 / (* cp   'A'     *)
                db      254
                db      65
; [230]   $d8 /       (* ret  c       *)
                db      216
; [231]   $fe / $5b / (* cp   'Z' + 1 *)
                db      254
                db      91
; [232]   $d0 /       (* ret  nc      *)
                db      208
; [233]   $cb / $ed / (* set  4,l     *)
                db      203
                db      237
; [234]   $c9         (* ret          *)
; [235] );
                db      201
                ret
; [236] 
; [237] 
; [238] 
; [239] var

; [240]   RandSeed1: Integer absolute 'seed1';
; [241]   RandSeed2: Integer absolute 'seed2';
; [242] 
; [243] function Random(Range: Integer): Integer; register; external '__random';
; [244] function RandomReal: Real; register;                external '__random48';

; [245] 
; [246] procedure Randomize; register; inline

__Randomize50:
; [247] (
; [248]   $ed / $5f /             (* ld   a,r             *)
                db      237
                db      95
; [249]   $2a / RandSeed1 /       (* ld   hl,(RandSeed1)  *)
                db      42
                dw      seed1
; [250]   $ed / $5b / RandSeed2 / (* ld   de,(RandSeed2)  *)
                db      237
                db      91
                dw      seed2
; [251]   $53 /                   (* ld   d,e             *)
                db      83
; [252]   $5c /                   (* ld   e,h             *)
                db      92
; [253]   $65 /                   (* ld   h,l             *)
                db      101
; [254]   $6f /                   (* ld   l,a             *)
                db      111
; [255]   $22 / RandSeed1 /       (* ld   (RandSeed1),hl  *)
                db      34
                dw      seed1
; [256]   $ed / $53 / RandSeed2 / (* ld   (RandSeed2),de  *)
                db      237
                db      83
                dw      seed2
; [257]   $c9                     (* ret                  *)
; [258] );
                db      201
                ret
; [259] 
; [260] procedure CheckBreak; register; external '__checkbreak';

; [261] 
; [262] procedure CheckStack; register; external '__checkstack';

; [263] 
; [264] (* Built-in: procedure FillChar(var Dest; Length: Integer; Data); *)
; [265] 
; [266] procedure Move(var Source, Dest; Count: Integer); register; external '__move';

; [267] 
; [268] (* Built-in: procedure Halt([ExitCode: Byte]) *)
; [269] 
; [270] 
; [271] 
; [272] (* -------------------------------------------------------------------------- *)
; [273] (* --- Assertion support ---------------------------------------------------- *)
; [274] (* -------------------------------------------------------------------------- *)
; [275] 
; [276] (* Built-in: procedure Assert(B: Boolean); *)
; [277] 
; [278] var

; [279]   AssertPassed: Integer absolute '__assertpassed';
; [280]   AssertFailed: Integer absolute '__assertfailed';
; [9] 
; [10] {$l cpm.asm     }
                include "/Users/joerg/Projects/pasta80/rtl/cpm.asm"
; [11] 
; [12] (* --------------------------------------------------------------------- *)
; [13] (* --- VT52 terminal support ------------------------------------------- *)
; [14] (* --------------------------------------------------------------------- *)
; [15] 
; [16] const
; [17]   (**
; [18]    * Defines the default with of the CP/M screen in characters.
; [19]    *)
; [20]   ScreenWidth = 80;
; [21] 
; [22]   (**
; [23]    * Defines the default height of the CP/M screen in characters.
; [24]    *)
; [25]   ScreenHeight = 24;
; [26] 
; [27]   (**
; [28]    * Defines the line break convention used by CP/M.
; [29]    *)
; [30]   LineBreak = #13#10;
; [31] 
; [32] procedure ConOut(C: Char); register;        external '__conout';
; [33] 
; [34] (**
; [35]  * Clears the screen. Uses the most recently defined text color and
; [36]  * background for the attribute area.
; [37]  *)
; [38] procedure ClrScr; register;                 external '__clrscr';

; [39] 
; [40] (**
; [41]  * Moves the the cursor (aka printing position) to a given location. Note
; [42]  * that Pascal expects the screen column (X) first, followed by the screen
; [43]  * row (Y).
; [44]  *)
; [45] procedure GotoXY(X, Y: Integer); register;  external '__gotoxy';

; [46] 
; [47] (**
; [48]  * Shows the cursor.
; [49]  *)
; [50] procedure CursorOn; register;               external '__cursor_on';

; [51] 
; [52] (**
; [53]  * Hides the cursor.
; [54]  *)
; [55] procedure CursorOff; register;              external '__cursor_off';

; [56] 
; [57] (**
; [58]  * Clear everything from the current cursor position to the end of the
; [59]  * line.
; [60]  *)
; [61] procedure ClrEol; register; inline

__ClrEol60:
; [62] (
; [63]   $3e / 27 /                  (* ld   a,27      *)
                db      62
                db      27
; [64]   $cd / ConOut /              (* call ConOut    *)
                db      205
                dw      __conout
; [65]   $3e / 'K' /                 (* ld   a,'K'     *)
                db      62
                db      75
; [66]   $cd / ConOut /              (* call ConOut    *)
                db      205
                dw      __conout
; [67]   $c9                         (* ret            *)
; [68] );
                db      201
                ret
; [69] 
; [70] (**
; [71]  * Clear everything from the current cursor position to the end of the
; [72]  * screen.
; [73]  *)
; [74] procedure ClrEos; register; inline

__ClrEos61:
; [75] (
; [76]   $3e / 27 /                  (* ld   a,27      *)
                db      62
                db      27
; [77]   $cd / ConOut /              (* call ConOut    *)
                db      205
                dw      __conout
; [78]   $3e / 'J' /                 (* ld   a,'J'     *)
                db      62
                db      74
; [79]   $cd / ConOut /              (* call ConOut    *)
                db      205
                dw      __conout
; [80]   $c9                         (* ret            *)
; [81] );
                db      201
                ret
; [82] 
; [83] (**
; [84]  * Inserts an empty line at the current cursor position, scrolling
; [85]  * everything that follows down.
; [86]  *)
; [87] procedure InsLine; register; inline

__InsLine62:
; [88] (
; [89]   $3e / 27 /                  (* ld   a,27      *)
                db      62
                db      27
; [90]   $cd / ConOut /              (* call ConOut    *)
                db      205
                dw      __conout
; [91]   $3e / 'L' /                 (* ld   a,'L'     *)
                db      62
                db      76
; [92]   $cd / ConOut /              (* call ConOut    *)
                db      205
                dw      __conout
; [93]   $c9                         (* ret            *)
; [94] );
                db      201
                ret
; [95] 
; [96] (**
; [97]  * Deletes a line at the current cursor position, scrolling everything that
; [98]  * follows up.
; [99]  *)
; [100] procedure DelLine; register; inline

__DelLine63:
; [101] (
; [102]   $2e / 27 /                  (* ld   l,27      *)
                db      46
                db      27
; [103]   $cd / ConOut /              (* call ConOut    *)
                db      205
                dw      __conout
; [104]   $3e / 'M' /                 (* ld   l,'M'     *)
                db      62
                db      77
; [105]   $cd / ConOut /              (* call ConOut    *)
                db      205
                dw      __conout
; [106]   $c9                         (* ret            *)
; [107] );
                db      201
                ret
; [108] 
; [109] (**
; [110]  * Sets the text color (0..7).
; [111]  *)
; [112] procedure TextColor(I: Integer); register;      external '__textfg';

; [113] 
; [114] (**
; [115]  * Sets the text background (0..7).
; [116]  *)
; [117] procedure TextBackground(I: Integer); register; external '__textbg';

; [118] 
; [119] (**
; [120]  * Sets the video to "high", whatever that is supposed be. Currently a
; [121]  * no-op and just defined to allow other code to build.
; [122]  *)
; [123] procedure HighVideo; register; inline

__HighVideo66:
; [124] (
; [125]   $c9 (* TODO implement me! *)
; [126] );
                db      201
                ret
; [127] 
; [128] (**
; [129]  * Sets the video to "low", whatever that is supposed be. Currently a
; [130]  * no-op and just defined to allow other code to build.
; [131]  *)
; [132] procedure LowVideo; register; inline

__LowVideo67:
; [133] (
; [134]   $c9 (* TODO implement me! *)
; [135] );
                db      201
                ret
; [136] 
; [137] (**
; [138]  * Sets the video to "norm", whatever that is supposed be. Currently a
; [139]  * no-op and just defined to allow other code to build.
; [140]  *)
; [141] procedure NormVideo; register; inline

__NormVideo68:
; [142] (
; [143]   $c9 (* TODO implement me! *)
; [144] );
                db      201
                ret
; [145] 
; [146] (* -------------------------------------------------------------------------- *)
; [147] (* --- Keyboard support ----------------------------------------------------- *)
; [148] (* -------------------------------------------------------------------------- *)
; [149] 
; [150] (**
; [151]  * Returns True if a key has been pressed (and can be queried using the
; [152]  * ReadKey function), False if not.
; [153]  *)
; [154] function KeyPressed: Boolean;

; [155] begin
; var KeyPressed(@RESULT)

__KeyPressed69:                         ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
; [156]   KeyPressed := BDOS(11, 0) <> 0;
                ld      hl,(display+2)  ; Local KeyPressed
                ld      de,4
                add     hl,de
                push    hl
                ld      de,11           ; Literal 11
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      c,l
                call    5
                ld      l,a
                ld      h,0
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     de
                pop     hl
                ld      (hl),e
; [157] end;
exit70:         ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [158] 
; [159] (**
; [160]  * Reads a key press and returns the corresponding ASCII character. Does
; [161]  * echo the character to the screen. Waits for a key press, if necessary,
; [162]  * so use KeyPressed first if you don't want your program to be delayed.
; [163]  *)
; [164] function ReadKey: CHar;

; [165] begin
; var ReadKey(@RESULT)

__ReadKey71:                            ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
; [166]   repeat until KeyPressed;
repeat73:
                ld      de,0            ; Literal 0
                push    de
                call    __KeyPressed69
                pop     hl
                bit     0,l
                jp      z,repeat73
break74:
; [167]   ReadKey := Chr(BDOS(6, 255));
                ld      hl,(display+2)  ; Local ReadKey
                ld      de,4
                add     hl,de
                push    hl
                ld      de,6            ; Literal 6
                push    de
                ld      de,255          ; Literal 255
                push    de
                pop     de
                pop     hl
                ld      c,l
                call    5
                ld      l,a
                ld      h,0
                push    hl
                pop     hl
                call    __Chr42
                push    hl
                pop     de
                pop     hl
                ld      (hl),e
; [168] end;
exit72:         ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [169] 
; [170] (**
; [171]  * Waits for the given interval in milliseconds. Assumes a CP/M platform
; [172]  * with BDOS call 141 (i.e. normally CP/M 3, but tnylpo has this as an
; [173]  * extension) and a "tick" value of 20 ms (which is the case for both the
; [174]  * Spectrum Next's CP/M and tnylpo).
; [175]  *)
; [176] procedure Delay(Duration: Integer);

; [177] var
; [178]   A: Byte;
global76:       ds      1,0             ; Global A
; [179] begin
; var Duration(+4), A(@global76)

__Delay75:                              ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [180]   A := BDos(141, Duration div 20);
                ld      hl,global76 + 0
                push    hl
                ld      de,141          ; Literal 141
                push    de
                ld      hl,(display+2)  ; Local Duration
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,20           ; Literal 20
                push    de
                pop     de
                pop     hl
                call    __sdiv16        ; Div
                push    hl
                pop     de
                pop     hl
                ld      c,l
                call    5
                ld      l,a
                ld      h,0
                push    hl
                pop     de
                pop     hl
                ld      (hl),e
; [181] end;
exit77:         ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [182] 
; [183] (* -------------------------------------------------------------------------- *)
; [184] (* --- Command-line parameters ---------------------------------------------- *)
; [185] (* -------------------------------------------------------------------------- *)
; [186] 
; [187] (**
; [188]  * Returns the number of command line parameters.
; [189]  *)
; [190] function ParamCount: Byte;

; [191] var
; [192]   CmdLine: String absolute $80;
; [193]   C, D: Boolean;
global79:       ds      1,0             ; Global C
global80:       ds      1,0             ; Global D
; [194]   I, J: Byte;
global81:       ds      1,0             ; Global I
global82:       ds      1,0             ; Global J
; [195] begin
; var ParamCount(@RESULT), CmdLine(@128), C(@global79), D(@global80), I(@global81), J(@global82)

__ParamCount78:                         ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                ld      hl,-264         ; Space
                add     hl,sp
                ld      sp,hl
; [196]   C := True;
                ld      hl,global79 + 0
                push    hl
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [197]   J := 0;
                ld      hl,global82 + 0
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [198] 
; [199]   for I := 1 to Length(CmdLine) do
                ld      hl,global81     ; Global I
                push    hl
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                ld      (hl),e
                push    hl
                ld      hl,128 + 0
                push    hl
                pop     hl
                call    __loadstr
                call    __length
; Post call cleanup 256 bytes
                call    __rmstr
                pop     de              ; Dup and pre-check limit
                push    de
                push    de
                ld      hl,global81     ; Global I
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     de              ; RelOp 14
                pop     hl
                call    __int16_geq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,forbreak85
forloop84:
; [200]   begin
; [201]     D := CmdLine[I] > ' ';
                ld      hl,global80 + 0
                push    hl
                ld      hl,128 + 0
                push    hl
                ld      hl,global81 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,32           ; Literal 32
                push    de
                pop     hl              ; RelOp 13
                pop     de
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
                pop     de
                pop     hl
                ld      (hl),e
; [202]     if not C and D then Inc(J);
                ld      hl,global79 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     hl              ; Not
                ld      a,1
                xor     l
                ld      l,a
                push    hl
                ld      hl,global80 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     de
                pop     hl
                ld      a,l
                and     e
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false87
                ld      hl,global82 + 0
                push    hl
                pop     hl
                inc     (hl)
false87:
; [203]     C := D;
                ld      hl,global79 + 0
                push    hl
                ld      hl,global80 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [204]   end;
fornext86:
                pop     de              ; Dup and check limit
                push    de
                push    de
                ld      hl,global81     ; Global I
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     hl              ; RelOp 13
                pop     de
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,forbreak85
                ld      hl,global81     ; Global I
                push    hl
                pop     hl
                inc     (hl)
                jp      forloop84
forbreak85:     pop     de              ; Cleanup limit
; [205] 
; [206]   ParamCount := J;
                ld      hl,(display+2)  ; Local ParamCount
                ld      de,4
                add     hl,de
                push    hl
                ld      hl,global82 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [207] end;
exit83:         ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [208] 
; [209] (**
; [210]  * Returns the I'th command line parameter, if it exists, or an empty
; [211]  * string otherwise.
; [212]  *)
; [213] function ParamStr(I: Byte): String;

; [214] var
; [215]   CmdLine: String absolute $80;
; [216]   C, D: Boolean;
global89:       ds      1,0             ; Global C
global90:       ds      1,0             ; Global D
; [217]   J, K: Byte;
global91:       ds      1,0             ; Global J
global92:       ds      1,0             ; Global K
; [218] begin
; var ParamStr(@RESULT), I(+4), CmdLine(@128), C(@global89), D(@global90), J(@global91), K(@global92)

__ParamStr88:                           ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                ld      hl,-264         ; Space
                add     hl,sp
                ld      sp,hl
; [219]   C := True;
                ld      hl,global89 + 0
                push    hl
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [220]   K := 1;
                ld      hl,global92 + 0
                push    hl
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [221] 
; [222]   for J := 1 to Length(CmdLine) do
                ld      hl,global91     ; Global J
                push    hl
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                ld      (hl),e
                push    hl
                ld      hl,128 + 0
                push    hl
                pop     hl
                call    __loadstr
                call    __length
; Post call cleanup 256 bytes
                call    __rmstr
                pop     de              ; Dup and pre-check limit
                push    de
                push    de
                ld      hl,global91     ; Global J
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     de              ; RelOp 14
                pop     hl
                call    __int16_geq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,forbreak95
forloop94:
; [223]   begin
; [224]     D := CmdLine[J] > ' ';
                ld      hl,global90 + 0
                push    hl
                ld      hl,128 + 0
                push    hl
                ld      hl,global91 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,32           ; Literal 32
                push    de
                pop     hl              ; RelOp 13
                pop     de
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
                pop     de
                pop     hl
                ld      (hl),e
; [225] 
; [226]     if not C and D then
                ld      hl,global89 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     hl              ; Not
                ld      a,1
                xor     l
                ld      l,a
                push    hl
                ld      hl,global90 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     de
                pop     hl
                ld      a,l
                and     e
                ld      l,a
                push    hl
; [227]       K := J
                pop     hl
                bit     0,l
                jp      z,false97
                ld      hl,global92 + 0
                push    hl
; [228]     else if C and not D then
                ld      hl,global91 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),e
                jp      endif98
false97:
                ld      hl,global89 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      hl,global90 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     hl              ; Not
                ld      a,1
                xor     l
                ld      l,a
                push    hl
                pop     de
                pop     hl
                ld      a,l
                and     e
                ld      l,a
                push    hl
; [229]     begin
                pop     hl
                bit     0,l
                jp      z,false99
; [230]       if I = 0 then
                ld      hl,(display+2)  ; Local I
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
; [231]       begin
                pop     hl
                bit     0,l
                jp      z,false100
; [232]         Dec(J);
                ld      hl,global91 + 0
                push    hl
                pop     hl
                dec     (hl)
; [233]         Break;
                jp      forbreak95      ; Break
; [234]       end;
false100:
; [235] 
; [236]       Dec(I);
                ld      hl,(display+2)  ; Local I
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                dec     (hl)
; [237]     end;
false99:
endif98:
; [238] 
; [239]     C := D;
                ld      hl,global89 + 0
                push    hl
                ld      hl,global90 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [240]   end;
fornext96:
                pop     de              ; Dup and check limit
                push    de
                push    de
                ld      hl,global91     ; Global J
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     hl              ; RelOp 13
                pop     de
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,forbreak95
                ld      hl,global91     ; Global J
                push    hl
                pop     hl
                inc     (hl)
                jp      forloop94
forbreak95:     pop     de              ; Cleanup limit
; [241] 
; [242]   if I = 0 then
                ld      hl,(display+2)  ; Local I
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
; [243]     ParamStr := Copy(CmdLine, K, J - K + 1)
                pop     hl
                bit     0,l
                jp      z,false101
                ld      hl,(display+2)  ; Local ParamStr
                ld      de,6
                add     hl,de
                push    hl
                call    __mkstr
                ld      hl,128 + 0
                push    hl
                pop     hl
                call    __loadstr
                ld      hl,global92 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      hl,global91 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      hl,global92 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     de
                pop     hl
                xor     a
                sbc     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
; [244]   else
                call    __copy
; Post call cleanup 260 bytes
                ld      hl,260          ; Clear
                add     hl,sp
                ld      sp,hl
                ld      a,255
                call    __storestr
                jp      endif102
false101:
; [245]     ParamStr := '';
                ld      hl,(display+2)  ; Local ParamStr
                ld      de,6
                add     hl,de
                push    hl
                ld      hl,string103
                push    hl
                pop     hl
                call    __loadstr
                ld      a,255
                call    __storestr
endif102:
; [246] end;
exit93:         ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [247] 
; [248] (* -------------------------------------------------------------------------- *)
; [249] (* --- CP/M BDOS interface including error handling ------------------------- *)
; [250] (* -------------------------------------------------------------------------- *)
; [251] 
; [252] const

; [253]   (**
; [254]    * The last error that occurred during file IO. Most file functions will
; [255]    * be disabled as long as this value is non-zero.
; [256]    *)
; [257]   LastError: Byte = 0;
const104:
                db      0
; [258] 
; [259] (**
; [260]  * Queries the last error that happened during an esxDOS call and resets
; [261]  * the value to zero, so that further esxDOS calls can be made.
; [262]  *)
; [263] function IOResult: Byte;
; [264] begin
; var IOResult(@RESULT)

__IOResult105:                          ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
; [265]   IOResult := LastError;
                ld      hl,(display+2)  ; Local IOResult
                ld      de,4
                add     hl,de
                push    hl
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [266]   LastError := 0;
                ld      hl,const104 + 0
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [267] end;
exit106:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [268] 
; [269] (**
; [270]  * Performs a BDOS call for the given function number and parameter value.
; [271]  * TODO Check if we can merge this with the built-in BDos and BDosHL
; [272]  * functions.
; [273]  *)
; [274] procedure BDosCatch(Func: Byte; Param: Integer);

; [275] var
; [276]   A: Byte;
global108:      ds      1,0             ; Global A
; [277] begin
; var Func(+6), Param(+4), A(@global108)

__BDosCatch107:                         ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [278]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false110
                jp      exit109         ; Exit
false110:
; [279]   A := BDos(Func, Param);
                ld      hl,global108 + 0
                push    hl
                ld      hl,(display+2)  ; Local Func
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      hl,(display+2)  ; Local Param
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      c,l
                call    5
                ld      l,a
                ld      h,0
                push    hl
                pop     de
                pop     hl
                ld      (hl),e
; [280]   (* WriteLn('BDos(', Func, ') returned A=' , A); *)
; [281]   if A <> 0 then LastError := A;
                ld      hl,global108 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false111
                ld      hl,const104 + 0
                push    hl
                ld      hl,global108 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),e
false111:
; [282] end;
exit109:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [283] 
; [284] (**
; [285]  * Checks the last BDOS error and terminates the program if it is <> 0.
; [286]  * Calls to this function are automatically generated by the compiler in
; [287]  * {$i+} mode.
; [288]  *)
; [289] procedure BDosThrow;

; [290] begin
__BDosThrow112:                         ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
; [291]   if LastError <> 0 then
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
; [292]   begin
                pop     hl
                bit     0,l
                jp      z,false114
; [293]     WriteLn('BDos error ', LastError);
                ld      hl,string115
                push    hl
                pop     hl
                call    __loadstr
                ld      hl,0
                add     hl,sp
                call    __puts
                call    __rmstr
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     hl
                call    __putn
                call    __newline
; [294]     Halt;
                jp      __done
; [295]   end;
false114:
; [296] end;
exit113:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [297] 
; [298] (* --------------------------------------------------------------------- *)
; [299] (* --- Internal implementation of "raw" untyped files ------------------ *)
; [300] (* --------------------------------------------------------------------- *)
; [301] 
; [302] type

; [303]   (**
; [304]    * Represents a CP/M file control block.
; [305]    *)
; [306]   FileControlBlock = record             
; [307]     DR: Byte;                           (* Drive number                       *)
; [308]     FN: array[0..7] of Char;            (* File name, 8 chars, space-padded   *)
; [309]     TN: array[0..2] of Char;            (* Extension, 3 chars, space-padded   *)
; [310]     EX, S1, S2, RC: Byte;               (* CP/M internal stuff                *)
; [311]     AL: array[0..15] of Byte;           (* CP/M internal stuff                *)
; [312]     CR: Byte;                           (* CP/M internal stuff                *)
; [313]     RL: Integer; RH: Byte;              (* 24 bit random record number        *)
; [314]   end;
; [315] 
; [316] procedure BlockAssign(var F: FileControlBlock; S: String);
; [317] var
; [318]   I, L, P, Q: Integer;
global117:      ds      2,0             ; Global I
global118:      ds      2,0             ; Global L
global119:      ds      2,0             ; Global P
global120:      ds      2,0             ; Global Q
; [319] begin
; var F(+260), S(+4), I(@global117), L(@global118), P(@global119), Q(@global120)

__BlockAssign116:                       ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
                push    hl
                push    hl
                push    hl
; [320]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false122
                jp      exit121         ; Exit
false122:
; [321] 
; [322]   with F do
                ld      hl,(display+2)  ; Local F
                ld      de,260
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [323]   begin
; [324]     L := Length(S);
                ld      hl,global118 + 0
                push    hl
                push    hl
                ld      hl,(display+2)  ; Local S
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                call    __loadstr
                call    __length
; Post call cleanup 256 bytes
                call    __rmstr
                pop     de
                pop     hl
                ld      (hl),de
; [325] 
; [326]     if (L > 1) and (S[2] = ':') then
                ld      hl,global118 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,1            ; Literal 1
                push    de
                pop     hl              ; RelOp 13
                pop     de
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
                ld      hl,(display+2)  ; Local S
                ld      de,4
                add     hl,de
                push    hl
                ld      de,2            ; Literal 2
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,58           ; Literal 58
                push    de
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
                pop     de
                pop     hl
                ld      a,l
                and     e
                ld      l,a
                push    hl
; [327]     begin
                pop     hl
                bit     0,l
                jp      z,false123
; [328]       DR := Ord(UpCase(S[1])) - 64;
                ld      hl,(display+2)  ; Local DR
                ld      de,-10
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local S
                ld      de,4
                add     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     hl
                call    __UpCase46
                push    hl
                ld      de,64           ; Literal 64
                push    de
                pop     de
                pop     hl
                xor     a
                sbc     hl,de
                push    hl
                pop     de
                pop     hl
                ld      (hl),e
; [329]       Delete(S, 1, 2);
                ld      hl,(display+2)  ; Local S
                ld      de,4
                add     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                ld      de,2            ; Literal 2
                push    de
                call    __delete
; Post call cleanup 6 bytes
                pop     hl
                pop     hl
                pop     hl
; [330]       Dec(L, 2);
                ld      hl,global118 + 0
                push    hl
                ld      de,2            ; Literal 2
                push    de
                pop     bc
                pop     hl
                call    __dec16by
; [331]     end
; [332]     else DR := 0;
                jp      endif124
false123:
                ld      hl,(display+2)  ; Local DR
                ld      de,-10
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
endif124:
; [333] 
; [334]     P := Pos('.', S);
                ld      hl,global119 + 0
                push    hl
                push    hl
                ld      de,46           ; Literal 46
                push    de
                pop     de
                call    __char2str
                ld      hl,(display+2)  ; Local S
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                call    __loadstr
                call    __pos
; Post call cleanup 512 bytes
                ld      hl,512          ; Clear
                add     hl,sp
                ld      sp,hl
                pop     de
                pop     hl
                ld      (hl),de
; [335]     if P = 0 then P := L + 1;
                ld      hl,global119 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false125
                ld      hl,global119 + 0
                push    hl
                ld      hl,global118 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     de
                pop     hl
                ld      (hl),de
false125:
; [336] 
; [337]     Q := P - 1;
                ld      hl,global120 + 0
                push    hl
                ld      hl,global119 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                xor     a
                sbc     hl,de
                push    hl
                pop     de
                pop     hl
                ld      (hl),de
; [338]     if Q > 8 then Q := 8;
                ld      hl,global120 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,8            ; Literal 8
                push    de
                pop     hl              ; RelOp 13
                pop     de
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false126
                ld      hl,global120 + 0
                push    hl
                ld      de,8            ; Literal 8
                push    de
                pop     de
                pop     hl
                ld      (hl),de
false126:
; [339] 
; [340]     for I := 1 to Q do FN[I - 1] := UpCase(S[I]);
                ld      hl,global117    ; Global I
                push    hl
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                ld      (hl),de
                ld      hl,global120 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de              ; Dup and pre-check limit
                push    de
                push    de
                ld      hl,global117    ; Global I
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de              ; RelOp 14
                pop     hl
                call    __int16_geq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,forbreak128
forloop127:
                ld      hl,(display+2)  ; Local FN
                ld      de,-10
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,1
                add     hl,de
                push    hl
                ld      hl,global117 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                xor     a
                sbc     hl,de
                push    hl
                pop     de
                pop     hl
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local S
                ld      de,4
                add     hl,de
                push    hl
                ld      hl,global117 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     hl
                call    __UpCase46
                push    hl
                pop     de
                pop     hl
                ld      (hl),e
fornext129:
                pop     de              ; Dup and check limit
                push    de
                push    de
                ld      hl,global117    ; Global I
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     hl              ; RelOp 13
                pop     de
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,forbreak128
                ld      hl,global117    ; Global I
                push    hl
                pop     hl
                call    __inc16
                jp      forloop127
forbreak128:    pop     de              ; Cleanup limit
; [341]     for I := Q + 1 to 8 do FN[I - 1] := ' ';
                ld      hl,global117    ; Global I
                push    hl
                ld      hl,global120 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     de
                pop     hl
                ld      (hl),de
                ld      de,8            ; Literal 8
                push    de
                pop     de              ; Dup and pre-check limit
                push    de
                push    de
                ld      hl,global117    ; Global I
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de              ; RelOp 14
                pop     hl
                call    __int16_geq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,forbreak131
forloop130:
                ld      hl,(display+2)  ; Local FN
                ld      de,-10
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,1
                add     hl,de
                push    hl
                ld      hl,global117 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                xor     a
                sbc     hl,de
                push    hl
                pop     de
                pop     hl
                add     hl,de
                push    hl
                ld      de,32           ; Literal 32
                push    de
                pop     de
                pop     hl
                ld      (hl),e
fornext132:
                pop     de              ; Dup and check limit
                push    de
                push    de
                ld      hl,global117    ; Global I
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     hl              ; RelOp 13
                pop     de
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,forbreak131
                ld      hl,global117    ; Global I
                push    hl
                pop     hl
                call    __inc16
                jp      forloop130
forbreak131:    pop     de              ; Cleanup limit
; [342] 
; [343]     Q := L - P;
                ld      hl,global120 + 0
                push    hl
                ld      hl,global118 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      hl,global119 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                xor     a
                sbc     hl,de
                push    hl
                pop     de
                pop     hl
                ld      (hl),de
; [344]     if Q > 3 then Q := 3;
                ld      hl,global120 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,3            ; Literal 3
                push    de
                pop     hl              ; RelOp 13
                pop     de
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false133
                ld      hl,global120 + 0
                push    hl
                ld      de,3            ; Literal 3
                push    de
                pop     de
                pop     hl
                ld      (hl),de
false133:
; [345] 
; [346]     for I := 1 to Q do TN[I - 1] := UpCase(S[P + I]);
                ld      hl,global117    ; Global I
                push    hl
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                ld      (hl),de
                ld      hl,global120 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de              ; Dup and pre-check limit
                push    de
                push    de
                ld      hl,global117    ; Global I
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de              ; RelOp 14
                pop     hl
                call    __int16_geq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,forbreak135
forloop134:
                ld      hl,(display+2)  ; Local TN
                ld      de,-10
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,9
                add     hl,de
                push    hl
                ld      hl,global117 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                xor     a
                sbc     hl,de
                push    hl
                pop     de
                pop     hl
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local S
                ld      de,4
                add     hl,de
                push    hl
                ld      hl,global119 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      hl,global117 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     hl
                call    __UpCase46
                push    hl
                pop     de
                pop     hl
                ld      (hl),e
fornext136:
                pop     de              ; Dup and check limit
                push    de
                push    de
                ld      hl,global117    ; Global I
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     hl              ; RelOp 13
                pop     de
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,forbreak135
                ld      hl,global117    ; Global I
                push    hl
                pop     hl
                call    __inc16
                jp      forloop134
forbreak135:    pop     de              ; Cleanup limit
; [347]     for I := Q + 1 to 3 do TN[I - 1] := ' ';
                ld      hl,global117    ; Global I
                push    hl
                ld      hl,global120 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     de
                pop     hl
                ld      (hl),de
                ld      de,3            ; Literal 3
                push    de
                pop     de              ; Dup and pre-check limit
                push    de
                push    de
                ld      hl,global117    ; Global I
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de              ; RelOp 14
                pop     hl
                call    __int16_geq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,forbreak138
forloop137:
                ld      hl,(display+2)  ; Local TN
                ld      de,-10
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,9
                add     hl,de
                push    hl
                ld      hl,global117 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                xor     a
                sbc     hl,de
                push    hl
                pop     de
                pop     hl
                add     hl,de
                push    hl
                ld      de,32           ; Literal 32
                push    de
                pop     de
                pop     hl
                ld      (hl),e
fornext139:
                pop     de              ; Dup and check limit
                push    de
                push    de
                ld      hl,global117    ; Global I
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     hl              ; RelOp 13
                pop     de
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,forbreak138
                ld      hl,global117    ; Global I
                push    hl
                pop     hl
                call    __inc16
                jp      forloop137
forbreak138:    pop     de              ; Cleanup limit
; [348] (*
; [349]     Write(DR, ':');
; [350]     for I := 0 to 7 do Write(FN[I]);
; [351]     Write('.');
; [352]     for I := 0 to 2 do Write(TN[I]);
; [353]     WriteLn;
; [354] *)
; [355]   end;
                pop     bc
; [356] end;
exit121:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [357] 
; [358] procedure BlockErase(var F: FileControlBlock);

; [359] var
; [360]   A: Byte;
global141:      ds      1,0             ; Global A
; [361] begin
; var F(+4), A(@global141)

__BlockErase140:                        ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [362]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false143
                jp      exit142         ; Exit
false143:
; [363]   A := BDos(*Catch*)(19, Addr(F));
                ld      hl,global141 + 0
                push    hl
                ld      de,19           ; Literal 19
                push    de
                ld      hl,(display+2)  ; Local F
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     de
                pop     hl
                ld      c,l
                call    5
                ld      l,a
                ld      h,0
                push    hl
                pop     de
                pop     hl
                ld      (hl),e
; [364] end;
exit142:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [365] 
; [366] procedure BlockRename(var F: FileControlBlock; S: String);

; [367] var
; [368]   G: FileControlBlock;
; [369]   A: Byte;
global145:      ds      1,0             ; Global A
; [370] begin
; var F(+260), S(+4), G(-36), A(@global145)

__BlockRename144:                       ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                ld      hl,-38          ; Space
                add     hl,sp
                ld      sp,hl
; [371]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false147
                jp      exit146         ; Exit
false147:
; [372]   BlockAssign(G, S);
                ld      hl,(display+2)  ; Local G
                ld      de,-36
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local S
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                call    __loadstr
                call    __BlockAssign116
; Post call cleanup 258 bytes
                ld      hl,258          ; Clear
                add     hl,sp
                ld      sp,hl
; [373]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false148
                jp      exit146         ; Exit
false148:
; [374]   Move(G, F.AL, 12);
                ld      hl,(display+2)  ; Local G
                ld      de,-36
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local F
                ld      de,260
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,16           ; Literal 16
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                ld      de,12           ; Literal 12
                push    de
                pop     bc
                pop     de
                pop     hl
                call    __move
; [375]   BDosCatch(23, Addr(F));
                ld      de,23           ; Literal 23
                push    de
                ld      hl,(display+2)  ; Local F
                ld      de,260
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __BDosCatch107
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [376] end;
exit146:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [377] 
; [378] procedure BlockReset(var F: FileControlBlock);

; [379] var
; [380]   A: Byte;
global150:      ds      1,0             ; Global A
; [381] begin
; var F(+4), A(@global150)

__BlockReset149:                        ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [382]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false152
                jp      exit151         ; Exit
false152:
; [383] 
; [384]   with F do
                ld      hl,(display+2)  ; Local F
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [385]   begin
; [386]     EX := 0;
                ld      hl,(display+2)  ; Local EX
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,12
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [387]     S1 := 0;
                ld      hl,(display+2)  ; Local S1
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,13
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [388]     S2 := 0;
                ld      hl,(display+2)  ; Local S2
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,14
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [389]     RC := 0;
                ld      hl,(display+2)  ; Local RC
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,15
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [390]     CR := 0;
                ld      hl,(display+2)  ; Local CR
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,32
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [391] 
; [392]     RL := 0;
                ld      hl,(display+2)  ; Local RL
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,33
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [393]     RH := 0;
                ld      hl,(display+2)  ; Local RH
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,35
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [394]   end;
                pop     bc
; [395] 
; [396]   BDosCatch(15, Addr(F));
                ld      de,15           ; Literal 15
                push    de
                ld      hl,(display+2)  ; Local F
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __BDosCatch107
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [397] end;
exit151:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [398] 
; [399] procedure BlockRewrite(var F: FileControlBlock);

; [400] var
; [401]   A: Byte;
global154:      ds      1,0             ; Global A
; [402] begin
; var F(+4), A(@global154)

__BlockRewrite153:                      ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [403]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false156
                jp      exit155         ; Exit
false156:
; [404] 
; [405]   with F do
                ld      hl,(display+2)  ; Local F
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [406]   begin
; [407]     EX := 0;
                ld      hl,(display+2)  ; Local EX
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,12
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [408]     S1 := 0;
                ld      hl,(display+2)  ; Local S1
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,13
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [409]     S2 := 0;
                ld      hl,(display+2)  ; Local S2
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,14
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [410]     RC := 0;
                ld      hl,(display+2)  ; Local RC
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,15
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [411]     CR := 0;
                ld      hl,(display+2)  ; Local CR
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,32
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [412] 
; [413]     RL := 0;
                ld      hl,(display+2)  ; Local RL
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,33
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [414]     RH := 0;
                ld      hl,(display+2)  ; Local RH
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,35
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [415]   end;
                pop     bc
; [416] 
; [417]   A := BDos(*Catch*)(19, Addr(F));
                ld      hl,global154 + 0
                push    hl
                ld      de,19           ; Literal 19
                push    de
                ld      hl,(display+2)  ; Local F
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     de
                pop     hl
                ld      c,l
                call    5
                ld      l,a
                ld      h,0
                push    hl
                pop     de
                pop     hl
                ld      (hl),e
; [418]   BDosCatch(22, Addr(F));
                ld      de,22           ; Literal 22
                push    de
                ld      hl,(display+2)  ; Local F
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __BDosCatch107
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [419] end;
exit155:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [420] 
; [421] procedure BlockClose(var F: FileControlBlock);

; [422] begin
; var F(+4)

__BlockClose157:                        ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
; [423]   BDosCatch(16, Addr(F));
                ld      de,16           ; Literal 16
                push    de
                ld      hl,(display+2)  ; Local F
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __BDosCatch107
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [424] end;
exit158:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [425] 
; [426] function BlockFilePos(var F: FileControlBlock): Integer;

; [427] begin
; var BlockFilePos(@RESULT), F(+4)

__BlockFilePos159:                      ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
; [428]   BlockFilePos := F.RL;
                ld      hl,(display+2)  ; Local BlockFilePos
                ld      de,6
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local F
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,33           ; Literal 33
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [429] end;
exit160:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [430] 
; [431] function BlockFileSize(var F: FileControlBlock): Integer;

; [432] var
; [433]   I: Integer;
global162:      ds      2,0             ; Global I
; [434] begin
; var BlockFileSize(@RESULT), F(+4), I(@global162)

__BlockFileSize161:                     ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [435]   with F do
                ld      hl,(display+2)  ; Local F
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [436]   begin
; [437]     I := RL;
                ld      hl,global162 + 0
                push    hl
                ld      hl,(display+2)  ; Local RL
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,33
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [438]     BDosCatch(35, Addr(F));
                ld      de,35           ; Literal 35
                push    de
                ld      hl,(display+2)  ; Local F
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __BDosCatch107
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [439]     if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false164
                jp      exit163         ; Exit
false164:
; [440]     BlockFileSize := RL;
                ld      hl,(display+2)  ; Local BlockFileSize
                ld      de,6
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local RL
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,33
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [441]     RL := I;
                ld      hl,(display+2)  ; Local RL
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,33
                add     hl,de
                push    hl
                ld      hl,global162 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [442]   end;
                pop     bc
; [443] end;
exit163:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [444] 
; [445] function BlockEof(var F: FileControlBlock): Boolean;

; [446] begin
; var BlockEof(@RESULT), F(+4)

__BlockEof165:                          ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
; [447]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false167
                jp      exit166         ; Exit
false167:
; [448] 
; [449]   BlockEof := BlockFilePos(F) = BlockFileSize(F);
                ld      hl,(display+2)  ; Local BlockEof
                ld      de,6
                add     hl,de
                push    hl
                push    hl
                ld      hl,(display+2)  ; Local F
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __BlockFilePos159
; Post call cleanup 2 bytes
                pop     hl
                push    hl
                ld      hl,(display+2)  ; Local F
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __BlockFileSize161
; Post call cleanup 2 bytes
                pop     hl
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
                pop     de
                pop     hl
                ld      (hl),e
; [450] end;
exit166:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [451] 
; [452] procedure BlockSeek(var F: FileControlBlock; I: Integer);

; [453] begin
; var F(+6), I(+4)

__BlockSeek168:                         ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
; [454]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false170
                jp      exit169         ; Exit
false170:
; [455] 
; [456]   F.RL := I;
                ld      hl,(display+2)  ; Local F
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,33           ; Literal 33
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local I
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [457] end;
exit169:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [458] 
; [459] procedure BlockBlockRead(var F: FileControlBlock; var Buffer; Count: Integer; var Actual: Integer);

; [460] var
; [461]   DMA: Integer;
global172:      ds      2,0             ; Global DMA
; [462] begin
; var F(+10), Buffer(+8), Count(+6), Actual(+4), DMA(@global172)

__BlockBlockRead171:                    ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [463]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false174
                jp      exit173         ; Exit
false174:
; [464] 
; [465]   DMA := Addr(Buffer);
                ld      hl,global172 + 0
                push    hl
                ld      hl,(display+2)  ; Local Buffer
                ld      de,8
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [466]   Actual := 0;
                ld      hl,(display+2)  ; Local Actual
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [467] 
; [468]   while Count > 0 do
while175:
                ld      hl,(display+2)  ; Local Count
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     hl              ; RelOp 13
                pop     de
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
; [469]   begin
                pop     hl
                bit     0,l
                jp      z,false176
; [470]     BDosCatch(26, DMA);
                ld      de,26           ; Literal 26
                push    de
                ld      hl,global172 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                call    __BDosCatch107
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [471]     BDosCatch(33, Addr(F));
                ld      de,33           ; Literal 33
                push    de
                ld      hl,(display+2)  ; Local F
                ld      de,10
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __BDosCatch107
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [472] 
; [473]     if LastError = 1 then
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,1            ; Literal 1
                push    de
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
; [474]     begin
                pop     hl
                bit     0,l
                jp      z,false177
; [475]       LastError := 0;
                ld      hl,const104 + 0
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [476]       Exit;
                jp      exit173         ; Exit
; [477]     end;
false177:
; [478] 
; [479]     if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false178
                jp      exit173         ; Exit
false178:
; [480] 
; [481]     Inc(F.RL);
                ld      hl,(display+2)  ; Local F
                ld      de,10
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,33           ; Literal 33
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                call    __inc16
; [482]     Inc(DMA, 128);
                ld      hl,global172 + 0
                push    hl
                ld      de,128          ; Literal 128
                push    de
                pop     bc
                pop     hl
                call    __inc16by
; [483]     Inc(Actual);
                ld      hl,(display+2)  ; Local Actual
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                call    __inc16
; [484]     Dec(Count);
                ld      hl,(display+2)  ; Local Count
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                call    __dec16
; [485]   end;
                jp      while175
false176:
; [486] end;
exit173:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [487] 
; [488] procedure BlockBlockWrite(var F: FileControlBlock; var Buffer; Count: Integer; Actual: Integer);

; [489] var
; [490]   DMA: Integer;
global180:      ds      2,0             ; Global DMA
; [491] begin
; var F(+10), Buffer(+8), Count(+6), Actual(+4), DMA(@global180)

__BlockBlockWrite179:                   ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [492]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false182
                jp      exit181         ; Exit
false182:
; [493] 
; [494]   DMA := Addr(Buffer);
                ld      hl,global180 + 0
                push    hl
                ld      hl,(display+2)  ; Local Buffer
                ld      de,8
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [495]   (*Actual := 0;*)
; [496] 
; [497]   while Count > 0 do
while183:
                ld      hl,(display+2)  ; Local Count
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     hl              ; RelOp 13
                pop     de
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
; [498]   begin
                pop     hl
                bit     0,l
                jp      z,false184
; [499]     BDosCatch(26, DMA);
                ld      de,26           ; Literal 26
                push    de
                ld      hl,global180 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                call    __BDosCatch107
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [500]     BDosCatch(34, Addr(F));
                ld      de,34           ; Literal 34
                push    de
                ld      hl,(display+2)  ; Local F
                ld      de,10
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __BDosCatch107
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [501]     if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false185
                jp      exit181         ; Exit
false185:
; [502] 
; [503]     Inc(F.RL);
                ld      hl,(display+2)  ; Local F
                ld      de,10
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,33           ; Literal 33
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                call    __inc16
; [504]     Inc(DMA, 128);
                ld      hl,global180 + 0
                push    hl
                ld      de,128          ; Literal 128
                push    de
                pop     bc
                pop     hl
                call    __inc16by
; [505] (*    Inc(Actual);*)
; [506]     Dec(Count);
                ld      hl,(display+2)  ; Local Count
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                call    __dec16
; [507]   end;
                jp      while183
false184:
; [508] end;
exit181:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [509] 
; [510] {$i files.pas}
; [0] (* --- Text file routines, use TextRec as representation -------------------- *)
; [1] 
; [2] type

; [3]   TextRec = record                      (* Internal text file representation  *)
; [4]     FCB: FileControlBlock;              (* FCB, *must* start at offset 0      *)
; [5]     Readable: Boolean;                  (* File is open for reading           *)
; [6]     Writable: Boolean;                  (* File is open for writing           *)
; [7]     EndOfFile: Boolean;
; [8]     Offset: Integer;                    (* Offset within 128 byte buffer      *)
; [9]     DMA: array[0..127] of Char;         (* Internal sector buffer             *)
; [10]   end;
; [11] 
; [12]   FileRec = record                      (* Internal typed file representation *)
; [13]     FCB: FileControlBlock;              (* FCB, *must* start at offset 0      *)
; [14]     CompSize: Integer;                  (* Size of component type             *)
; [15]     CompCount: Integer;                 (* Number of components in file       *)
; [16]     CompIndex: Integer;                 (* Index of current component         *)
; [17]     Offset: Integer;                    (* Offset within 128 byte buffer      *)
; [18]     Modified: Boolean;                  (* Current record has been modified   *)
; [19]     case Boolean of
; [20]       False: (DMA: array[0..127] of Char;); (* Internal sector buffer         *)
; [21]       True:  (HdrCount, HdrSize: Integer;); (* Typed file header              *)
; [22]   end;
; [23] 
; [24] procedure TextAssign(var T: TextRec; Name: String);
; [25] begin
; var T(+260), Name(+4)

__TextAssign186:                        ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
; [26]   BlockAssign(T.FCB, Name);
                ld      hl,(display+2)  ; Local T
                ld      de,260
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local Name
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                call    __loadstr
                call    __BlockAssign116
; Post call cleanup 258 bytes
                ld      hl,258          ; Clear
                add     hl,sp
                ld      sp,hl
; [27] end;
exit187:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [28] 
; [29] procedure TextReset(var T: TextRec);

; [30] var
; [31]   E: Integer;
global189:      ds      2,0             ; Global E
; [32] begin
; var T(+4), E(@global189)

__TextReset188:                         ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [33]   with T do
                ld      hl,(display+2)  ; Local T
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [34]   begin
; [35]     BlockReset(FCB);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __BlockReset149
; Post call cleanup 2 bytes
                pop     hl
; [36]     BlockBlockRead(FCB, DMA, 1, E);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local DMA
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,41
                add     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                ld      hl,global189 + 0
                push    hl
                call    __BlockBlockRead171
; Post call cleanup 8 bytes
                pop     hl
                pop     hl
                pop     hl
                pop     hl
; [37] 
; [38]     if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false191
                jp      exit190         ; Exit
false191:
; [39] 
; [40]     Readable := True;
                ld      hl,(display+2)  ; Local Readable
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,36
                add     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [41]     Writable := False;
                ld      hl,(display+2)  ; Local Writable
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,37
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [42] 
; [43]     Offset := 0;
                ld      hl,(display+2)  ; Local Offset
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,39
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [44]     EndOfFile := E = 0;
                ld      hl,(display+2)  ; Local EndOfFile
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,38
                add     hl,de
                push    hl
                ld      hl,global189 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
                pop     de
                pop     hl
                ld      (hl),e
; [45]   end;
                pop     bc
; [46] end;
exit190:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [47] 
; [48] procedure TextRewrite(var T: TextRec);

; [49] begin
; var T(+4)

__TextRewrite192:                       ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
; [50]   with T do
                ld      hl,(display+2)  ; Local T
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [51]   begin
; [52]     BlockRewrite(FCB);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-2
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __BlockRewrite153
; Post call cleanup 2 bytes
                pop     hl
; [53] 
; [54]     if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false194
                jp      exit193         ; Exit
false194:
; [55] 
; [56]     Readable := False;
                ld      hl,(display+2)  ; Local Readable
                ld      de,-2
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,36
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [57]     Writable := True;
                ld      hl,(display+2)  ; Local Writable
                ld      de,-2
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,37
                add     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [58] 
; [59]     Offset := 0;
                ld      hl,(display+2)  ; Local Offset
                ld      de,-2
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,39
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [60]   end;
                pop     bc
; [61] end;
exit193:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [62] 
; [63] procedure TextReadChar(var T: TextRec; var C: Char);

; [64] var
; [65]   E: Integer;
global196:      ds      2,0             ; Global E
; [66] begin
; var T(+6), C(+4), E(@global196)

__TextReadChar195:                      ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [67]   with T do
                ld      hl,(display+2)  ; Local T
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [68]   begin
; [69]     if EndOfFile then
                ld      hl,(display+2)  ; Local EndOfFile
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,38
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
; [70]     begin
                pop     hl
                bit     0,l
                jp      z,false198
; [71]       C := #26;
                ld      hl,(display+2)  ; Local C
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,26           ; Literal 26
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [72]       Exit;
                jp      exit197         ; Exit
; [73]     end;
false198:
; [74] 
; [75]     C := DMA[Offset];
                ld      hl,(display+2)  ; Local C
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local DMA
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,41
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local Offset
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,39
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [76]     if C <> #26 then
                ld      hl,(display+2)  ; Local C
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,26           ; Literal 26
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
; [77]     begin
                pop     hl
                bit     0,l
                jp      z,false199
; [78]       Inc(Offset);
                ld      hl,(display+2)  ; Local Offset
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,39
                add     hl,de
                push    hl
                pop     hl
                call    __inc16
; [79]       if Offset = 128 then
                ld      hl,(display+2)  ; Local Offset
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,39
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,128          ; Literal 128
                push    de
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
; [80]       begin
                pop     hl
                bit     0,l
                jp      z,false200
; [81]         BlockBlockRead(FCB, DMA, 1, E);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local DMA
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,41
                add     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                ld      hl,global196 + 0
                push    hl
                call    __BlockBlockRead171
; Post call cleanup 8 bytes
                pop     hl
                pop     hl
                pop     hl
                pop     hl
; [82]         if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false201
                jp      exit197         ; Exit
false201:
; [83]         Offset := 0;
                ld      hl,(display+2)  ; Local Offset
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,39
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [84]         EndOfFile := E = 0;
                ld      hl,(display+2)  ; Local EndOfFile
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,38
                add     hl,de
                push    hl
                ld      hl,global196 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
                pop     de
                pop     hl
                ld      (hl),e
; [85]       end;
false200:
; [86]     end;
false199:
; [87]   end;
                pop     bc
; [88] end;
exit197:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [89] 
; [90] procedure TextReadStr(var T: TextRec; var S: String);

; [91] var
; [92]   C: Char;
global203:      ds      1,0             ; Global C
; [93] begin
; var T(+6), S(+4), C(@global203)

__TextReadStr202:                       ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [94]   S := '';
                ld      hl,(display+2)  ; Local S
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,string103
                push    hl
                pop     hl
                call    __loadstr
                ld      a,255
                call    __storestr
; [95] 
; [96]   while Length(S) < 255 do
while205:
                push    hl
                ld      hl,(display+2)  ; Local S
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                call    __loadstr
                call    __length
; Post call cleanup 256 bytes
                call    __rmstr
                ld      de,255          ; Literal 255
                push    de
                pop     de              ; RelOp 11
                pop     hl
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
; [97]   begin
                pop     hl
                bit     0,l
                jp      z,false206
; [98]     TextReadChar(T, C);
                ld      hl,(display+2)  ; Local T
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,global203 + 0
                push    hl
                call    __TextReadChar195
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [99]     if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false207
                jp      exit204         ; Exit
false207:
; [100] 
; [101]     if C = #10 then Break;
                ld      hl,global203 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,10           ; Literal 10
                push    de
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false208
                jp      false206        ; Break
false208:
; [102]     if C = #13 then
                ld      hl,global203 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,13           ; Literal 13
                push    de
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
; [103]     begin
                pop     hl
                bit     0,l
                jp      z,false209
; [104]       if T.DMA[T.Offset] = #10 then TextReadChar(T, C);
                ld      hl,(display+2)  ; Local T
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,41           ; Literal 41
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local T
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,39           ; Literal 39
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,10           ; Literal 10
                push    de
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false210
                ld      hl,(display+2)  ; Local T
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,global203 + 0
                push    hl
                call    __TextReadChar195
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
false210:
; [105]       Break;
                jp      false206        ; Break
; [106]     end;
false209:
; [107]     if C = #26 then Break;
                ld      hl,global203 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,26           ; Literal 26
                push    de
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false211
                jp      false206        ; Break
false211:
; [108] 
; [109]     if C >= ' ' then S := S + C;
                ld      hl,global203 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,32           ; Literal 32
                push    de
                pop     de              ; RelOp 14
                pop     hl
                call    __int16_geq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false212
                ld      hl,(display+2)  ; Local S
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local S
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                call    __loadstr
                ld      hl,global203 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     de
                call    __char2str
                call    __stradd
                call    __rmstr
                ld      a,255
                call    __storestr
false212:
; [110]   end;
                jp      while205
false206:
; [111] end;
exit204:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [112] 
; [113] procedure TextReadWord(var T: TextRec; var S: String);

; [114] var
; [115]   C: Char;
global214:      ds      1,0             ; Global C
; [116] begin
; var T(+6), S(+4), C(@global214)

__TextReadWord213:                      ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [117]   S := '';
                ld      hl,(display+2)  ; Local S
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,string103
                push    hl
                pop     hl
                call    __loadstr
                ld      a,255
                call    __storestr
; [118] 
; [119]   while Length(S) < 255 do
while216:
                push    hl
                ld      hl,(display+2)  ; Local S
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                call    __loadstr
                call    __length
; Post call cleanup 256 bytes
                call    __rmstr
                ld      de,255          ; Literal 255
                push    de
                pop     de              ; RelOp 11
                pop     hl
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
; [120]   begin
                pop     hl
                bit     0,l
                jp      z,false217
; [121]     TextReadChar(T, C);
                ld      hl,(display+2)  ; Local T
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,global214 + 0
                push    hl
                call    __TextReadChar195
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [122]     if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false218
                jp      exit215         ; Exit
false218:
; [123] 
; [124]     if C > ' ' then S := S + C else Break;
                ld      hl,global214 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,32           ; Literal 32
                push    de
                pop     hl              ; RelOp 13
                pop     de
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false219
                ld      hl,(display+2)  ; Local S
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local S
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                call    __loadstr
                ld      hl,global214 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     de
                call    __char2str
                call    __stradd
                call    __rmstr
                ld      a,255
                call    __storestr
                jp      endif220
false219:
                jp      false217        ; Break
endif220:
; [125]   end;
                jp      while216
false217:
; [126] end;
exit215:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [127] 
; [128] procedure TextReadInt(var T: TextRec; var I: Integer);

; [129] var
; [130]   S: String;
; [131]   E: Integer;
global222:      ds      2,0             ; Global E
; [132] begin
; var T(+6), I(+4), S(-256), E(@global222)

__TextReadInt221:                       ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                ld      hl,-258         ; Space
                add     hl,sp
                ld      sp,hl
; [133]   TextReadWord(T, S);
                ld      hl,(display+2)  ; Local T
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local S
                ld      de,-256
                add     hl,de
                push    hl
                call    __TextReadWord213
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [134]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false224
                jp      exit223         ; Exit
false224:
; [135]   Val(S, I, E);
                ld      hl,(display+2)  ; Local S
                ld      de,-256
                add     hl,de
                push    hl
                pop     hl
                call    __loadstr
                ld      hl,(display+2)  ; Local I
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,global222 + 0
                push    hl
                call    __val_int
; [136] end;
exit223:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [137] 
; [138] procedure TextReadFloat(var T: TextRec; var R: Real);

; [139] var
; [140]   S: String;
; [141]   E: Integer;
global226:      ds      2,0             ; Global E
; [142] begin
; var T(+6), R(+4), S(-256), E(@global226)

__TextReadFloat225:                     ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                ld      hl,-258         ; Space
                add     hl,sp
                ld      sp,hl
; [143]   TextReadWord(T, S);
                ld      hl,(display+2)  ; Local T
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local S
                ld      de,-256
                add     hl,de
                push    hl
                call    __TextReadWord213
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [144]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false228
                jp      exit227         ; Exit
false228:
; [145]   Val(S, R, E);
                ld      hl,(display+2)  ; Local S
                ld      de,-256
                add     hl,de
                push    hl
                pop     hl
                call    __loadstr
                ld      hl,(display+2)  ; Local R
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,global226 + 0
                push    hl
                call    __val_float
; [146] end;
exit227:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [147] 
; [148] procedure TextWriteChar(var T: TextRec; C: Char);

; [149] var
; [150]   E: Integer;
global230:      ds      2,0             ; Global E
; [151] begin
; var T(+6), C(+4), E(@global230)

__TextWriteChar229:                     ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [152]   with T do
                ld      hl,(display+2)  ; Local T
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [153]   begin
; [154]     DMA[Offset] := C;
                ld      hl,(display+2)  ; Local DMA
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,41
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local Offset
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,39
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local C
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [155]     Inc(Offset);
                ld      hl,(display+2)  ; Local Offset
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,39
                add     hl,de
                push    hl
                pop     hl
                call    __inc16
; [156]     if Offset = 128 then
                ld      hl,(display+2)  ; Local Offset
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,39
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,128          ; Literal 128
                push    de
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
; [157]     begin
                pop     hl
                bit     0,l
                jp      z,false232
; [158]       BlockBlockWrite(FCB, DMA, 1, E);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local DMA
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,41
                add     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                ld      hl,global230 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                call    __BlockBlockWrite179
; Post call cleanup 8 bytes
                pop     hl
                pop     hl
                pop     hl
                pop     hl
; [159]       if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false233
                jp      exit231         ; Exit
false233:
; [160]       Offset := 0;
                ld      hl,(display+2)  ; Local Offset
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,39
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [161]     end;
false232:
; [162]   end;
                pop     bc
; [163] end;
exit231:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [164] 
; [165] procedure TextFlush(var T: TextRec);

; [166] var
; [167]   E: Integer;
global235:      ds      2,0             ; Global E
; [168] begin
; var T(+4), E(@global235)

__TextFlush234:                         ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [169]   with T do
                ld      hl,(display+2)  ; Local T
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [170]   begin
; [171]     (* FIXME !!! *)
; [172]     TextWriteChar(T, #26);
                ld      hl,(display+2)  ; Local T
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,26           ; Literal 26
                push    de
                call    __TextWriteChar229
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [173] 
; [174]     if Offset <> 0 then
                ld      hl,(display+2)  ; Local Offset
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,39
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
; [175]       BlockBlockWrite(FCB, DMA, 1, E);
                pop     hl
                bit     0,l
                jp      z,false237
                ld      hl,(display+2)  ; Local FCB
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local DMA
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,41
                add     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                ld      hl,global235 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                call    __BlockBlockWrite179
; Post call cleanup 8 bytes
                pop     hl
                pop     hl
                pop     hl
                pop     hl
false237:
; [176] 
; [177]     if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false238
                jp      exit236         ; Exit
false238:
; [178] 
; [179]     Readable := False;
                ld      hl,(display+2)  ; Local Readable
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,36
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [180]     Writable := False;
                ld      hl,(display+2)  ; Local Writable
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,37
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [181]   end;
                pop     bc
; [182] end;
exit236:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [183] 
; [184] procedure TextClose(var T: TextRec);

; [185] var
; [186]   E: Integer;
global240:      ds      2,0             ; Global E
; [187] begin
; var T(+4), E(@global240)

__TextClose239:                         ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [188]   with T do
                ld      hl,(display+2)  ; Local T
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [189]   begin
; [190]     if Writable then TextFlush(T);
                ld      hl,(display+2)  ; Local Writable
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,37
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     hl
                bit     0,l
                jp      z,false242
                ld      hl,(display+2)  ; Local T
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __TextFlush234
; Post call cleanup 2 bytes
                pop     hl
false242:
; [191] 
; [192]     BlockClose(FCB);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __BlockClose157
; Post call cleanup 2 bytes
                pop     hl
; [193] 
; [194]     if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false243
                jp      exit241         ; Exit
false243:
; [195] 
; [196]     Readable := False;
                ld      hl,(display+2)  ; Local Readable
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,36
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [197]     Writable := False;
                ld      hl,(display+2)  ; Local Writable
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,37
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [198]   end;
                pop     bc
; [199] end;
exit241:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [200] 
; [201] procedure TextWriteStr(var T: TextRec; S: String);

; [202] var
; [203]   I: Byte;
global245:      ds      1,0             ; Global I
; [204] begin
; var T(+260), S(+4), I(@global245)

__TextWriteStr244:                      ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [205]   for I := 1 to Length(S) do
                ld      hl,global245    ; Global I
                push    hl
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                ld      (hl),e
                push    hl
                ld      hl,(display+2)  ; Local S
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                call    __loadstr
                call    __length
; Post call cleanup 256 bytes
                call    __rmstr
                pop     de              ; Dup and pre-check limit
                push    de
                push    de
                ld      hl,global245    ; Global I
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     de              ; RelOp 14
                pop     hl
                call    __int16_geq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,forbreak248
forloop247:
; [206]   begin
; [207]     TextWriteChar(T, S[I]);
                ld      hl,(display+2)  ; Local T
                ld      de,260
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local S
                ld      de,4
                add     hl,de
                push    hl
                ld      hl,global245 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                call    __TextWriteChar229
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [208]     if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false250
                jp      exit246         ; Exit
false250:
; [209]   end;
fornext249:
                pop     de              ; Dup and check limit
                push    de
                push    de
                ld      hl,global245    ; Global I
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     hl              ; RelOp 13
                pop     de
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,forbreak248
                ld      hl,global245    ; Global I
                push    hl
                pop     hl
                inc     (hl)
                jp      forloop247
forbreak248:    pop     de              ; Cleanup limit
; [210] end;
exit246:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [211] 
; [212] procedure TextWriteEoln(var T: TextRec);

; [213] begin
; var T(+4)

__TextWriteEoln251:                     ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
; [214]   TextWriteStr(T, LineBreak);
                ld      hl,(display+2)  ; Local T
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,string54
                call    __loadstr
                call    __TextWriteStr244
; Post call cleanup 258 bytes
                ld      hl,258          ; Clear
                add     hl,sp
                ld      sp,hl
; [215] end;
exit252:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [216] 
; [217] function TextEoln(var T: TextRec): Boolean;

; [218] begin
; var TextEoln(@RESULT), T(+4)

__TextEoln253:                          ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
; [219]   with T do
                ld      hl,(display+2)  ; Local T
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [220]     TextEoln := DMA[Offset] = #13;
                ld      hl,(display+2)  ; Local TextEoln
                ld      de,6
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local DMA
                ld      de,-2
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,41
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local Offset
                ld      de,-2
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,39
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,13           ; Literal 13
                push    de
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
                pop     de
                pop     hl
                ld      (hl),e
                pop     bc
; [221] end;
exit254:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [222] 
; [223] function TextEof(var T: TextRec): Boolean;

; [224] begin
; var TextEof(@RESULT), T(+4)

__TextEof255:                           ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
; [225]   with T do
                ld      hl,(display+2)  ; Local T
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [226]     TextEof := EndOfFile or (DMA[Offset] = #26);
                ld      hl,(display+2)  ; Local TextEof
                ld      de,6
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local EndOfFile
                ld      de,-2
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,38
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      hl,(display+2)  ; Local DMA
                ld      de,-2
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,41
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local Offset
                ld      de,-2
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,39
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,26           ; Literal 26
                push    de
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
                pop     de
                pop     hl
                ld      a,l
                or      e
                ld      l,a
                push    hl
                pop     de
                pop     hl
                ld      (hl),e
                pop     bc
; [227] end;
exit256:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [228] 
; [229] procedure TextSeekEof(var T: TextRec);

; [230] var
; [231]   E: Integer;
global258:      ds      2,0             ; Global E
; [232]   C: Char;
global259:      ds      1,0             ; Global C
; [233] begin
; var T(+4), E(@global258), C(@global259)

__TextSeekEof257:                       ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
                push    hl
; [234]   with T do
                ld      hl,(display+2)  ; Local T
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [235]   begin
; [236]     BlockSeek(FCB, BlockFileSize(FCB) - 1);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                push    hl
                ld      hl,(display+2)  ; Local FCB
                ld      de,-6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __BlockFileSize161
; Post call cleanup 2 bytes
                pop     hl
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                xor     a
                sbc     hl,de
                push    hl
                call    __BlockSeek168
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [237]     BlockBlockRead(FCB, DMA, 1, E);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local DMA
                ld      de,-6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,41
                add     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                ld      hl,global258 + 0
                push    hl
                call    __BlockBlockRead171
; Post call cleanup 8 bytes
                pop     hl
                pop     hl
                pop     hl
                pop     hl
; [238] 
; [239]     if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false261
                jp      exit260         ; Exit
false261:
; [240] 
; [241]     while not TextEof(T) do
while262:
                ld      de,0            ; Literal 0
                push    de
                ld      hl,(display+2)  ; Local T
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __TextEof255
; Post call cleanup 2 bytes
                pop     hl
                pop     hl              ; Not
                ld      a,1
                xor     l
                ld      l,a
                push    hl
; [242]       TextReadChar(T, C);
                pop     hl
                bit     0,l
                jp      z,false263
                ld      hl,(display+2)  ; Local T
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,global259 + 0
                push    hl
                call    __TextReadChar195
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
                jp      while262
false263:
; [243]   end;
                pop     bc
; [244] end;
exit260:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [245] 
; [246] procedure TextSeekEoln(var T: TextRec);

; [247] var
; [248]   C: Char;
global265:      ds      1,0             ; Global C
; [249] begin
; var T(+4), C(@global265)

__TextSeekEoln264:                      ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [250]   with T do
                ld      hl,(display+2)  ; Local T
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [251]   begin
; [252]     while DMA[Offset] <> #13 do
while267:
                ld      hl,(display+2)  ; Local DMA
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,41
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local Offset
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,39
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,13           ; Literal 13
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
; [253]     begin
                pop     hl
                bit     0,l
                jp      z,false268
; [254]       TextReadChar(T, C);
                ld      hl,(display+2)  ; Local T
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,global265 + 0
                push    hl
                call    __TextReadChar195
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [255]       if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false269
                jp      exit266         ; Exit
false269:
; [256]     end;
                jp      while267
false268:
; [257]   end;
                pop     bc
; [258] end;
exit266:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [259] 
; [260] procedure TextAppend(var T: TextRec);

; [261] begin
; var T(+4)

__TextAppend270:                        ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
; [262]   with T do
                ld      hl,(display+2)  ; Local T
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [263]   begin
; [264]     TextReset(T);
                ld      hl,(display+2)  ; Local T
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __TextReset188
; Post call cleanup 2 bytes
                pop     hl
; [265]     TextSeekEof(T);
                ld      hl,(display+2)  ; Local T
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __TextSeekEof257
; Post call cleanup 2 bytes
                pop     hl
; [266] 
; [267]     if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false272
                jp      exit271         ; Exit
false272:
; [268] 
; [269]     BlockSeek(FCB, FCB.RL - 1);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-2
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local FCB
                ld      de,-2
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,33           ; Literal 33
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                xor     a
                sbc     hl,de
                push    hl
                call    __BlockSeek168
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [270] 
; [271]     Readable := False;
                ld      hl,(display+2)  ; Local Readable
                ld      de,-2
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,36
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [272]     Writable := True;
                ld      hl,(display+2)  ; Local Writable
                ld      de,-2
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,37
                add     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [273]   end;
                pop     bc
; [274] end;
exit271:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [275] 
; [276] (* --- Typed file routines, use FileRec as representation ------------------- *)
; [277] 
; [278] procedure FileAssign(var F: FileRec; Name: String; Size: Integer);

; [279] begin
; var F(+262), Name(+6), Size(+4)

__FileAssign273:                        ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
; [280]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false275
                jp      exit274         ; Exit
false275:
; [281] 
; [282]   with F do
                ld      hl,(display+2)  ; Local F
                ld      de,262
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [283]   begin
; [284]     BlockAssign(FCB, Name);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-2
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local Name
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                call    __loadstr
                call    __BlockAssign116
; Post call cleanup 258 bytes
                ld      hl,258          ; Clear
                add     hl,sp
                ld      sp,hl
; [285]     CompSize := Size;
                ld      hl,(display+2)  ; Local CompSize
                ld      de,-2
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,36
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local Size
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [286]   end;
                pop     bc
; [287] end;
exit274:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [288] 
; [289] procedure FileReset(var F: FileRec);

; [290] var
; [291]   E: Integer;
global277:      ds      2,0             ; Global E
; [292] begin
; var F(+4), E(@global277)

__FileReset276:                         ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [293]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false279
                jp      exit278         ; Exit
false279:
; [294] 
; [295]   with F do
                ld      hl,(display+2)  ; Local F
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [296]   begin
; [297]     BlockReset(FCB);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __BlockReset149
; Post call cleanup 2 bytes
                pop     hl
; [298]     BlockBlockRead(FCB, DMA, 1, E);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local DMA
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,45
                add     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                ld      hl,global277 + 0
                push    hl
                call    __BlockBlockRead171
; Post call cleanup 8 bytes
                pop     hl
                pop     hl
                pop     hl
                pop     hl
; [299] 
; [300]     if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false280
                jp      exit278         ; Exit
false280:
; [301] 
; [302]     if CompSize <> HdrSize then
                ld      hl,(display+2)  ; Local CompSize
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,36
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      hl,(display+2)  ; Local HdrSize
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,47
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
; [303]     begin
                pop     hl
                bit     0,l
                jp      z,false281
; [304]       WriteLn('Invalid file type');
                ld      hl,string282
                push    hl
                pop     hl
                call    __loadstr
                ld      hl,0
                add     hl,sp
                call    __puts
                call    __rmstr
                call    __newline
; [305]       Halt;
                jp      __done
; [306]     end;
false281:
; [307] 
; [308]     CompCount := HdrCount;
                ld      hl,(display+2)  ; Local CompCount
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,38
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local HdrCount
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,45
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [309]     CompIndex := 0;
                ld      hl,(display+2)  ; Local CompIndex
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,40
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [310] 
; [311]     Offset := 4;
                ld      hl,(display+2)  ; Local Offset
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,42
                add     hl,de
                push    hl
                ld      de,4            ; Literal 4
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [312]     Modified := False;
                ld      hl,(display+2)  ; Local Modified
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,44
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [313] 
; [314]     (*WriteLn('Opened existing file, size=', CompSize, ' count=', CompCount);
; [315]     ReadLn;*)
; [316]   end;
                pop     bc
; [317] end;
exit278:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [318] 
; [319] procedure FileRewrite(var F: FileRec);

; [320] var
; [321]   E: Integer;
global284:      ds      2,0             ; Global E
; [322] begin
; var F(+4), E(@global284)

__FileRewrite283:                       ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [323]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false286
                jp      exit285         ; Exit
false286:
; [324] 
; [325]   with F do
                ld      hl,(display+2)  ; Local F
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [326]   begin
; [327]     BlockRewrite(FCB);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __BlockRewrite153
; Post call cleanup 2 bytes
                pop     hl
; [328] 
; [329]     if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false287
                jp      exit285         ; Exit
false287:
; [330] 
; [331]     HdrSize := CompSize;
                ld      hl,(display+2)  ; Local HdrSize
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,47
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local CompSize
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,36
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [332]     HdrCount := 0;
                ld      hl,(display+2)  ; Local HdrCount
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,45
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [333] 
; [334]     CompCount := 0;
                ld      hl,(display+2)  ; Local CompCount
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,38
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [335]     CompIndex := 0;
                ld      hl,(display+2)  ; Local CompIndex
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,40
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [336] 
; [337]     Offset := 4;
                ld      hl,(display+2)  ; Local Offset
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,42
                add     hl,de
                push    hl
                ld      de,4            ; Literal 4
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [338]     Modified := True;
                ld      hl,(display+2)  ; Local Modified
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,44
                add     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [339] 
; [340]     BlockBlockWrite(FCB, DMA, 1, E); (* TODO Delay this until Flush/Close? *)
                ld      hl,(display+2)  ; Local FCB
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local DMA
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,45
                add     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                ld      hl,global284 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                call    __BlockBlockWrite179
; Post call cleanup 8 bytes
                pop     hl
                pop     hl
                pop     hl
                pop     hl
; [341] 
; [342]     if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false288
                jp      exit285         ; Exit
false288:
; [343] 
; [344]     (*WriteLn('Created new file, size=', CompSize, ' count=', CompCount);*)
; [345]   end;
                pop     bc
; [346] end;
exit285:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [347] 
; [348] function FileFileSize(var F: FileRec): Integer;

; [349] begin
; var FileFileSize(@RESULT), F(+4)

__FileFileSize289:                      ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
; [350]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false291
                jp      exit290         ; Exit
false291:
; [351] 
; [352]   FileFileSize := F.CompCount;
                ld      hl,(display+2)  ; Local FileFileSize
                ld      de,6
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local F
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,38           ; Literal 38
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [353] end;
exit290:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [354] 
; [355] function FileFilePos(var F: FileRec): Integer;

; [356] begin
; var FileFilePos(@RESULT), F(+4)

__FileFilePos292:                       ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
; [357]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false294
                jp      exit293         ; Exit
false294:
; [358] 
; [359]   FileFilePos := F.CompIndex;
                ld      hl,(display+2)  ; Local FileFilePos
                ld      de,6
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local F
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,40           ; Literal 40
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [360] end;
exit293:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [361] 
; [362] function FileEof(var F: FileRec): Boolean;

; [363] begin
; var FileEof(@RESULT), F(+4)

__FileEof295:                           ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
; [364]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false297
                jp      exit296         ; Exit
false297:
; [365] 
; [366]   with F do
                ld      hl,(display+2)  ; Local F
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [367]     FileEof := CompIndex = CompCount;
                ld      hl,(display+2)  ; Local FileEof
                ld      de,6
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local CompIndex
                ld      de,-2
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,40
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      hl,(display+2)  ; Local CompCount
                ld      de,-2
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,38
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
                pop     de
                pop     hl
                ld      (hl),e
                pop     bc
; [368] end;
exit296:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [369] 
; [370] procedure FileFlush(var F: FileRec);

; [371] var
; [372]   E: Integer;
global299:      ds      2,0             ; Global E
; [373] begin
; var F(+4), E(@global299)

__FileFlush298:                         ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [374]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false301
                jp      exit300         ; Exit
false301:
; [375] 
; [376]   with F do
                ld      hl,(display+2)  ; Local F
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [377]   begin
; [378]     if Modified then
                ld      hl,(display+2)  ; Local Modified
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,44
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
; [379]     begin
                pop     hl
                bit     0,l
                jp      z,false302
; [380]       BlockSeek(FCB, FCB.RL - 1);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local FCB
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,33           ; Literal 33
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                xor     a
                sbc     hl,de
                push    hl
                call    __BlockSeek168
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [381]       BlockBlockWrite(FCB, DMA, 1, E);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local DMA
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,45
                add     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                ld      hl,global299 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                call    __BlockBlockWrite179
; Post call cleanup 8 bytes
                pop     hl
                pop     hl
                pop     hl
                pop     hl
; [382]       if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false303
                jp      exit300         ; Exit
false303:
; [383]       Modified := False;
                ld      hl,(display+2)  ; Local Modified
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,44
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [384]     end;
false302:
; [385]   end;
                pop     bc
; [386] end;
exit300:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [387] 
; [388] procedure FileSeek(var F: FileRec; I: Integer);

; [389] var
; [390]   P, S: Real;
global305:      ds      6,0             ; Global P
global306:      ds      6,0             ; Global S
; [391]   E: Integer;
global307:      ds      2,0             ; Global E
; [392] begin
; var F(+6), I(+4), P(@global305), S(@global306), E(@global307)

__FileSeek304:                          ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                ld      hl,-14          ; Space
                add     hl,sp
                ld      sp,hl
; [393]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false309
                jp      exit308         ; Exit
false309:
; [394] 
; [395]   with F do
                ld      hl,(display+2)  ; Local F
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [396]   begin
; [397]     FileFlush(F);
                ld      hl,(display+2)  ; Local F
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __FileFlush298
; Post call cleanup 2 bytes
                pop     hl
; [398] 
; [399]     if I > CompCount then
                ld      hl,(display+2)  ; Local I
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      hl,(display+2)  ; Local CompCount
                ld      de,-16
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,38
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     hl              ; RelOp 13
                pop     de
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
; [400]     begin
                pop     hl
                bit     0,l
                jp      z,false310
; [401]       WriteLn('*** ', I, ' > ', CompCount);
                ld      hl,string311
                push    hl
                pop     hl
                call    __loadstr
                ld      hl,0
                add     hl,sp
                call    __puts
                call    __rmstr
                ld      hl,(display+2)  ; Local I
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     hl
                call    __putn
                ld      hl,string312
                push    hl
                pop     hl
                call    __loadstr
                ld      hl,0
                add     hl,sp
                call    __puts
                call    __rmstr
                ld      hl,(display+2)  ; Local CompCount
                ld      de,-16
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,38
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     hl
                call    __putn
                call    __newline
; [402]       Halt;
                jp      __done
; [403]     end;
false310:
; [404] 
; [405]     if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false313
                jp      exit308         ; Exit
false313:
; [406] 
; [407]     P := 4.0 + I * 1.0 * CompSize;    (* Should we use Real here?    *)
                ld      hl,global305 + 0
                push    hl
                constfp 0x0083,0x0000,0x0000
                pushfp
                ld      hl,(display+2)  ; Local I
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                constfp 0x0081,0x0000,0x0000
                pushfp
                popfp
                exx
                pop     hl
                exx
                pushfp
                exx
                call    FLOAT
                exx
                popfp
                exx
                pushfp
                exx
                pushfp
                popfp
                exx
                popfp
                call    FPMUL
                pushfp
                ld      hl,(display+2)  ; Local CompSize
                ld      de,-16
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,36
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     hl
                call    FLOAT
                pushfp
                popfp
                exx
                popfp
                call    FPMUL
                pushfp
                popfp
                exx
                popfp
                call    FPADD
                pushfp
                popfp
                exx
                pop     hl
                call    __storefp
; [408]     S := Int(P / 128);
                ld      hl,global306 + 0
                push    hl
                ld      hl,global305 + 0
                push    hl
                pop     hl
                call    __loadfp
                pushfp
                ld      de,128          ; Literal 128
                push    de
                pop     hl
                call    FLOAT
                pushfp
                popfp
                exx
                popfp
                call    FPDIV
                pushfp
                popfp
                call    INT
                pushfp
                popfp
                exx
                pop     hl
                call    __storefp
; [409]     (* WriteLn('Seeking to index ', I, ' offset ', P, ' sector ', S);*)
; [410]     BlockSeek(FCB, Trunc(S));  (* Why does div not work here? *)
                ld      hl,(display+2)  ; Local FCB
                ld      de,-16
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,global306 + 0
                push    hl
                pop     hl
                call    __loadfp
                pushfp
                popfp
                call    FIX
                push    hl
                call    __BlockSeek168
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [411]     if I < CompCount then
                ld      hl,(display+2)  ; Local I
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      hl,(display+2)  ; Local CompCount
                ld      de,-16
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,38
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de              ; RelOp 11
                pop     hl
                call    __int16_lt
                ld      h,0
                ld      l,a
                push    hl
; [412]       BlockBlockRead(FCB, DMA, 1, E)
                pop     hl
                bit     0,l
                jp      z,false314
                ld      hl,(display+2)  ; Local FCB
                ld      de,-16
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local DMA
                ld      de,-16
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,45
                add     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                ld      hl,global307 + 0
                push    hl
; [413]     else
                call    __BlockBlockRead171
; Post call cleanup 8 bytes
                pop     hl
                pop     hl
                pop     hl
                pop     hl
                jp      endif315
false314:
; [414]       BlockSeek(FCB, FCB.RL + 1);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-16
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local FCB
                ld      de,-16
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,33           ; Literal 33
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                call    __BlockSeek168
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
endif315:
; [415] 
; [416]     if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false316
                jp      exit308         ; Exit
false316:
; [417] 
; [418]     Offset := Trunc(P - 128 * S); (* Abs(P mod 128); *)
                ld      hl,(display+2)  ; Local Offset
                ld      de,-16
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,42
                add     hl,de
                push    hl
                ld      hl,global305 + 0
                push    hl
                pop     hl
                call    __loadfp
                pushfp
                ld      de,128          ; Literal 128
                push    de
                ld      hl,global306 + 0
                push    hl
                pop     hl
                call    __loadfp
                pushfp
                popfp
                exx
                pop     hl
                exx
                pushfp
                exx
                call    FLOAT
                exx
                popfp
                exx
                pushfp
                exx
                pushfp
                popfp
                exx
                popfp
                call    FPMUL
                pushfp
                popfp
                exx
                popfp
                call    FPSUB
                pushfp
                popfp
                call    FIX
                push    hl
                pop     de
                pop     hl
                ld      (hl),de
; [419] 
; [420]     CompIndex := I;
                ld      hl,(display+2)  ; Local CompIndex
                ld      de,-16
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,40
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local I
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [421]   end;
                pop     bc
; [422] end;
exit308:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [423] 
; [424] procedure FileRead(var F: FileRec; var Comp);

; [425] var
; [426]   Address, Need, Avail, Bytes, E: Integer;
global318:      ds      2,0             ; Global Address
global319:      ds      2,0             ; Global Need
global320:      ds      2,0             ; Global Avail
global321:      ds      2,0             ; Global Bytes
global322:      ds      2,0             ; Global E
; [427]   (*Mem: array[0..65535] of Byte absolute 0;*)
; [428]   P: ^Byte absolute Address;
; [429] begin
; var F(+6), Comp(+4), Address(@global318), Need(@global319), Avail(@global320), Bytes(@global321), E(@global322), P(@global318)

__FileRead317:                          ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                ld      hl,-12          ; Space
                add     hl,sp
                ld      sp,hl
; [430]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false324
                jp      exit323         ; Exit
false324:
; [431] 
; [432]   (* WriteLn('Read entry #', FileFilePos(F)); *)
; [433] 
; [434]   with F do
                ld      hl,(display+2)  ; Local F
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [435]   begin
; [436]     Address := Addr(Comp);
                ld      hl,global318 + 0
                push    hl
                ld      hl,(display+2)  ; Local Comp
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [437]     Need := CompSize;
                ld      hl,global319 + 0
                push    hl
                ld      hl,(display+2)  ; Local CompSize
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,36
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [438] 
; [439]     while Need <> 0 do
while325:
                ld      hl,global319 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
; [440]     begin
                pop     hl
                bit     0,l
                jp      z,false326
; [441]       Avail := 128 - Offset;
                ld      hl,global320 + 0
                push    hl
                ld      de,128          ; Literal 128
                push    de
                ld      hl,(display+2)  ; Local Offset
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,42
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                xor     a
                sbc     hl,de
                push    hl
                pop     de
                pop     hl
                ld      (hl),de
; [442]       if Avail >= Need then
                ld      hl,global320 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      hl,global319 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de              ; RelOp 14
                pop     hl
                call    __int16_geq
                ld      h,0
                ld      l,a
                push    hl
; [443]         Bytes := Need
                pop     hl
                bit     0,l
                jp      z,false327
                ld      hl,global321 + 0
                push    hl
; [444]       else
                ld      hl,global319 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
                jp      endif328
false327:
; [445]         Bytes := Avail;
                ld      hl,global321 + 0
                push    hl
                ld      hl,global320 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
endif328:
; [446] 
; [447]       Move(DMA[Offset], P^, Bytes); (* Hmm... feels like a hack. *)
                ld      hl,(display+2)  ; Local DMA
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,45
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local Offset
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,42
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                ld      hl,global318 + 0
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,global321 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     bc
                pop     de
                pop     hl
                call    __move
; [448]       Inc(Address, Bytes);
                ld      hl,global318 + 0
                push    hl
                ld      hl,global321 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     bc
                pop     hl
                call    __inc16by
; [449]       Inc(Offset, Bytes);
                ld      hl,(display+2)  ; Local Offset
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,42
                add     hl,de
                push    hl
                ld      hl,global321 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     bc
                pop     hl
                call    __inc16by
; [450]       Dec(Need, Bytes);
                ld      hl,global319 + 0
                push    hl
                ld      hl,global321 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     bc
                pop     hl
                call    __dec16by
; [451] 
; [452]       if Offset = 128 then
                ld      hl,(display+2)  ; Local Offset
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,42
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,128          ; Literal 128
                push    de
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
; [453]       begin
                pop     hl
                bit     0,l
                jp      z,false329
; [454]         FileFlush(F);
                ld      hl,(display+2)  ; Local F
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __FileFlush298
; Post call cleanup 2 bytes
                pop     hl
; [455]         if FileEof(F) then
                ld      de,0            ; Literal 0
                push    de
                ld      hl,(display+2)  ; Local F
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __FileEof295
; Post call cleanup 2 bytes
                pop     hl
; [456]           BlockSeek(FCB, FCB.RL + 1)
                pop     hl
                bit     0,l
                jp      z,false330
                ld      hl,(display+2)  ; Local FCB
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local FCB
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,33           ; Literal 33
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
; [457]         else
                call    __BlockSeek168
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
                jp      endif331
false330:
; [458]           BlockBlockRead(FCB, DMA, 1, E);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local DMA
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,45
                add     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                ld      hl,global322 + 0
                push    hl
                call    __BlockBlockRead171
; Post call cleanup 8 bytes
                pop     hl
                pop     hl
                pop     hl
                pop     hl
endif331:
; [459]         if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false332
                jp      exit323         ; Exit
false332:
; [460]         Offset := 0;
                ld      hl,(display+2)  ; Local Offset
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,42
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [461]       end;
false329:
; [462]     end;
                jp      while325
false326:
; [463] 
; [464]     Inc(CompIndex);
                ld      hl,(display+2)  ; Local CompIndex
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,40
                add     hl,de
                push    hl
                pop     hl
                call    __inc16
; [465]   end;
                pop     bc
; [466] end;
exit323:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [467] 
; [468] procedure FileWrite(var F: FileRec; var Comp);

; [469] var
; [470]   Address, Need, Avail, Bytes, E: Integer;
global334:      ds      2,0             ; Global Address
global335:      ds      2,0             ; Global Need
global336:      ds      2,0             ; Global Avail
global337:      ds      2,0             ; Global Bytes
global338:      ds      2,0             ; Global E
; [471]   (*Mem: array[0..65535] of Byte absolute 0;*)
; [472]   P: ^Byte absolute Address;
; [473] begin
; var F(+6), Comp(+4), Address(@global334), Need(@global335), Avail(@global336), Bytes(@global337), E(@global338), P(@global334)

__FileWrite333:                         ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                ld      hl,-12          ; Space
                add     hl,sp
                ld      sp,hl
; [474]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false340
                jp      exit339         ; Exit
false340:
; [475] 
; [476]   (* WriteLn('Wrote entry #', FileFilePos(F)); *)
; [477] 
; [478]   with F do
                ld      hl,(display+2)  ; Local F
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [479]   begin
; [480]     Address := Addr(Comp);
                ld      hl,global334 + 0
                push    hl
                ld      hl,(display+2)  ; Local Comp
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [481]     Need := CompSize;
                ld      hl,global335 + 0
                push    hl
                ld      hl,(display+2)  ; Local CompSize
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,36
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [482] 
; [483]     while Need <> 0 do
while341:
                ld      hl,global335 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
; [484]     begin
                pop     hl
                bit     0,l
                jp      z,false342
; [485]       Avail := 128 - Offset;
                ld      hl,global336 + 0
                push    hl
                ld      de,128          ; Literal 128
                push    de
                ld      hl,(display+2)  ; Local Offset
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,42
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                xor     a
                sbc     hl,de
                push    hl
                pop     de
                pop     hl
                ld      (hl),de
; [486]       if Avail >= Need then
                ld      hl,global336 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      hl,global335 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de              ; RelOp 14
                pop     hl
                call    __int16_geq
                ld      h,0
                ld      l,a
                push    hl
; [487]         Bytes := Need
                pop     hl
                bit     0,l
                jp      z,false343
                ld      hl,global337 + 0
                push    hl
; [488]       else
                ld      hl,global335 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
                jp      endif344
false343:
; [489]         Bytes := Avail;
                ld      hl,global337 + 0
                push    hl
                ld      hl,global336 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
endif344:
; [490] 
; [491]       Move(P^, DMA[Offset], Bytes); (* Hmm... feels like a hack. *)
                ld      hl,global334 + 0
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local DMA
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,45
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local Offset
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,42
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                ld      hl,global337 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     bc
                pop     de
                pop     hl
                call    __move
; [492]       Inc(Address, Bytes);
                ld      hl,global334 + 0
                push    hl
                ld      hl,global337 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     bc
                pop     hl
                call    __inc16by
; [493]       Inc(Offset, Bytes);
                ld      hl,(display+2)  ; Local Offset
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,42
                add     hl,de
                push    hl
                ld      hl,global337 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     bc
                pop     hl
                call    __inc16by
; [494]       Dec(Need, Bytes);
                ld      hl,global335 + 0
                push    hl
                ld      hl,global337 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     bc
                pop     hl
                call    __dec16by
; [495]       Modified := True;
                ld      hl,(display+2)  ; Local Modified
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,44
                add     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [496] 
; [497]       if Offset = 128 then
                ld      hl,(display+2)  ; Local Offset
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,42
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,128          ; Literal 128
                push    de
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
; [498]       begin
                pop     hl
                bit     0,l
                jp      z,false345
; [499]         FileFlush(F);
                ld      hl,(display+2)  ; Local F
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __FileFlush298
; Post call cleanup 2 bytes
                pop     hl
; [500]         if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false346
                jp      exit339         ; Exit
false346:
; [501] 
; [502]         if FileEof(F) then
                ld      de,0            ; Literal 0
                push    de
                ld      hl,(display+2)  ; Local F
                ld      de,6
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __FileEof295
; Post call cleanup 2 bytes
                pop     hl
; [503]           BlockSeek(FCB, FCB.RL + 1)
                pop     hl
                bit     0,l
                jp      z,false347
                ld      hl,(display+2)  ; Local FCB
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local FCB
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,33           ; Literal 33
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
; [504]         else
                call    __BlockSeek168
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
                jp      endif348
false347:
; [505]           BlockBlockRead(FCB, DMA, 1, E);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local DMA
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,45
                add     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                ld      hl,global338 + 0
                push    hl
                call    __BlockBlockRead171
; Post call cleanup 8 bytes
                pop     hl
                pop     hl
                pop     hl
                pop     hl
endif348:
; [506] 
; [507]         Offset := 0;
                ld      hl,(display+2)  ; Local Offset
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,42
                add     hl,de
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [508]       end;
false345:
; [509]     end;
                jp      while341
false342:
; [510] 
; [511]     if CompIndex = CompCount then Inc(CompCount);
                ld      hl,(display+2)  ; Local CompIndex
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,40
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                ld      hl,(display+2)  ; Local CompCount
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,38
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false349
                ld      hl,(display+2)  ; Local CompCount
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,38
                add     hl,de
                push    hl
                pop     hl
                call    __inc16
false349:
; [512]     Inc(CompIndex);
                ld      hl,(display+2)  ; Local CompIndex
                ld      de,-14
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,40
                add     hl,de
                push    hl
                pop     hl
                call    __inc16
; [513]   end;
                pop     bc
; [514] end;
exit339:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [515] 
; [516] procedure FileClose(var F: FileRec);

; [517] var
; [518]   E: Integer;
global351:      ds      2,0             ; Global E
; [519] begin
; var F(+4), E(@global351)

__FileClose350:                         ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                push    hl
; [520]   if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false353
                jp      exit352         ; Exit
false353:
; [521] 
; [522]   with F do
                ld      hl,(display+2)  ; Local F
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
; [523]   begin
; [524]     FileFlush(F);
                ld      hl,(display+2)  ; Local F
                ld      de,4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __FileFlush298
; Post call cleanup 2 bytes
                pop     hl
; [525] 
; [526]     BlockSeek(FCB, 0);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                call    __BlockSeek168
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [527]     BlockBlockRead(FCB, DMA, 1, E);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local DMA
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,45
                add     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                ld      hl,global351 + 0
                push    hl
                call    __BlockBlockRead171
; Post call cleanup 8 bytes
                pop     hl
                pop     hl
                pop     hl
                pop     hl
; [528] 
; [529]     if LastError <> 0 then Exit;
                ld      hl,const104 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                pop     de              ; RelOp 10
                pop     hl
                call    __int16_neq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,false354
                jp      exit352         ; Exit
false354:
; [530] 
; [531]     HdrCount := CompCount;
                ld      hl,(display+2)  ; Local HdrCount
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,45
                add     hl,de
                push    hl
                ld      hl,(display+2)  ; Local CompCount
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,38
                add     hl,de
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [532] 
; [533]     (*WriteLn('File closing: ', CompCount, '*', CompCount, ' --- ', HdrCount, '*', HdrSize);
; [534]     ReadLn; *)
; [535] 
; [536]     BlockSeek(FCB, 0);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      de,0            ; Literal 0
                push    de
                call    __BlockSeek168
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [537]     BlockBlockWrite(FCB, DMA, 1, E);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                ld      hl,(display+2)  ; Local DMA
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                pop     hl
                ld      de,45
                add     hl,de
                push    hl
                ld      de,1            ; Literal 1
                push    de
                ld      hl,global351 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                call    __BlockBlockWrite179
; Post call cleanup 8 bytes
                pop     hl
                pop     hl
                pop     hl
                pop     hl
; [538]     BlockClose(FCB);
                ld      hl,(display+2)  ; Local FCB
                ld      de,-4
                add     hl,de
                push    hl
                pop     hl
                ld      e,(hl)
                inc     hl
                ld      d,(hl)
                push    de
                call    __BlockClose157
; Post call cleanup 2 bytes
                pop     hl
; [539]   end;
                pop     bc
; [540]   (* WriteLn('Closed file'); *)
; [541] end;
exit352:        ld      sp,(display+2)  ; Epilogue
                pop     hl
                ld      (display+2),hl
                ret
; [511] 
; [512] end.

; [0] program Day06;
; [1] 
; [2] var
; [3]   Map: array[0..129, 0..129] of Char;
global355:      ds      16900,0         ; Global Map
; [4]   Seen: array[0..129, 0..129] of Byte;
global356:      ds      16900,0         ; Global Seen
; [5] 
; [6]   Width, Height, StartX, StartY: Integer;
global357:      ds      2,0             ; Global Width
global358:      ds      2,0             ; Global Height
global359:      ds      2,0             ; Global StartX
global360:      ds      2,0             ; Global StartY
; [7] 
; [8] procedure Load(Name: String);
; [9] var
; [10]   T: Text;
; [11]   J: Integer;
global362:      ds      2,0             ; Global J
; [12]   C: Char;
global363:      ds      1,0             ; Global C
; [13]   S: String;
; [14] begin
; var Name(+4), T(-256), J(@global362), C(@global363), S(-516)

__Load361:                              ; Prologue
                ld      hl,(display+2)
                push    hl
                ld      (display+2),sp
                ld      hl,-516         ; Space
                add     hl,sp
                ld      sp,hl
; [15]   Width := 0;
                ld      hl,global357 + 0
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [16]   Height := 0;
                ld      hl,global358 + 0
                push    hl
                ld      de,0            ; Literal 0
                push    de
                pop     de
                pop     hl
                ld      (hl),de
; [17] 
; [18]   Assign(T, 'input.txt');
                ld      hl,(display+2)  ; Local T
                ld      de,-256
                add     hl,de
                push    hl
                ld      hl,string365
                push    hl
                pop     hl
                call    __loadstr
                call    __TextAssign186
; Post call cleanup 258 bytes
                ld      hl,258          ; Clear
                add     hl,sp
                ld      sp,hl
; [19]   Reset(T);
                ld      hl,(display+2)  ; Local T
                ld      de,-256
                add     hl,de
                push    hl
                call    __TextReset188
; Post call cleanup 2 bytes
                pop     hl
; [20]   
; [21]   while not Eof(T) do
while366:
                push    de
                ld      hl,(display+2)  ; Local T
                ld      de,-256
                add     hl,de
                push    hl
                call    __TextEof255
; Post call cleanup 2 bytes
                pop     hl
                pop     hl              ; Not
                ld      a,1
                xor     l
                ld      l,a
                push    hl
; [22]   begin
                pop     hl
                bit     0,l
                jp      z,false367
; [23]     ReadLn(T, S);
                ld      hl,(display+2)  ; Local T
                ld      de,-256
                add     hl,de
                push    hl
                pop     hl
                ld      (__cur_file),hl
                ld      hl,(__cur_file)
                push    hl
                ld      hl,(display+2)  ; Local S
                ld      de,-516
                add     hl,de
                push    hl
                call    __TextReadStr202
; Post call cleanup 4 bytes
                pop     hl
                pop     hl
; [24]     for J := 1 to Length(S) do
                ld      hl,global362    ; Global J
                push    hl
                ld      de,1            ; Literal 1
                push    de
                pop     de
                pop     hl
                ld      (hl),de
                push    hl
                ld      hl,(display+2)  ; Local S
                ld      de,-516
                add     hl,de
                push    hl
                pop     hl
                call    __loadstr
                call    __length
; Post call cleanup 256 bytes
                call    __rmstr
                pop     de              ; Dup and pre-check limit
                push    de
                push    de
                ld      hl,global362    ; Global J
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de              ; RelOp 14
                pop     hl
                call    __int16_geq
                ld      h,0
                ld      l,a
                push    hl
                pop     hl
                bit     0,l
                jp      z,forbreak369
forloop368:
; [25]     begin
; [26]       C := S[J];
                ld      hl,global363 + 0
                push    hl
                ld      hl,(display+2)  ; Local S
                ld      de,-516
                add     hl,de
                push    hl
                ld      hl,global362 + 0
                push    hl
                pop     hl
                ld      de,(hl)
                push    de
                pop     de
                pop     hl
                add     hl,de
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                pop     de
                pop     hl
                ld      (hl),e
; [27]       if C = '^' then
                ld      hl,global363 + 0
                push    hl
                pop     hl
                ld      d,0
                ld      e,(hl)
                push    de
                ld      de,94           ; Literal 94
                push    de
                pop     de              ; RelOp 9
                pop     hl
                call    __int16_eq
                ld      h,0
                ld      l,a
                push    hl
; [28]       begin
                pop     hl
                bit     0,l
                jp      z,false371
; [29]         StartX := Height;
                ld      hl,global359 + 0
                push    hl
                ld      hl,global358 + 0
                push    hl
                po